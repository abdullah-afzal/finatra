
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Creating an injectable util-app App &#8212; Finatra 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/flasky.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Creating an injectable TwitterServer" href="../twitter-server/index.html" />
    <link rel="prev" title="Custom Logback AsyncAppender" href="../logging/asyncappender.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../twitter-server/index.html" title="Creating an injectable TwitterServer"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../logging/asyncappender.html" title="Custom Logback AsyncAppender"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Creating an injectable <cite>util-app App</cite></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="creating-an-injectable-c-t-app-app">
<span id="app"></span><h1>Creating an injectable <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>util-app App</cite></a><a class="headerlink" href="#creating-an-injectable-c-t-app-app" title="Permalink to this headline">¶</a></h1>
<section id="lifecycle">
<h2>Lifecycle<a class="headerlink" href="#lifecycle" title="Permalink to this headline">¶</a></h2>
<p>If you haven’t already, take a look at the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>util-app App</cite></a>
<a class="reference external" href="../getting-started/lifecycle.html#c-t-app-app-lifecycle">lifecycle documentation</a>.</p>
</section>
<section id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>To create an injectable <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>util-app App</cite></a>, first depend on the <cite>inject-app</cite> library. Then use the
<a class="reference external" href="../getting-started/framework.html#inject">inject framework</a> to create an injectable App. Finatra
provides an injectable version of the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>util-app App</cite></a> trait: <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a>. We
also recommend using <a class="reference external" href="https://logback.qos.ch/">Logback</a> as your <a class="reference external" href="https://www.slf4j.org/manual.html">SLF4J</a>
implementation.</p>
<p>E.g., with sbt:</p>
<pre class="literal-block">&quot;com.twitter&quot; %% &quot;inject-app&quot; % &quot;24.2.0&quot;,
&quot;ch.qos.logback&quot; % &quot;logback-classic&quot; % versions.logback,</pre>
<p>For more information on logging with Finatra see: <a class="reference external" href="../logging/index.html#introduction-to-logging-with-finatra">Introduction to Logging With Finatra</a>.</p>
<p>Extending the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> trait creates an injectable <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>util-app App</cite></a>.</p>
<p>This allows for the use of <a class="reference external" href="../getting-started/dependency_injection.html#dependency-injection">dependency injection</a>
in a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>util-app App</cite></a> with support for <a class="reference external" href="../getting-started/modules.html">modules</a> which allows for
<a class="reference external" href="../testing/index.html#types-of-tests">powerful feature testing</a> of the application.</p>
</section>
<section id="scala-example">
<h2>Scala Example<a class="headerlink" href="#scala-example" title="Permalink to this headline">¶</a></h2>
<p>Given a <a class="reference external" href="../getting-started/modules.html">module</a> definition:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">TwitterModule</span>

<span class="k">object</span> <span class="nc">MyModule1</span> <span class="k">extends</span> <span class="nc">TwitterModule</span> <span class="p">{</span>

  <span class="nd">@Singleton</span>
  <span class="nd">@Provides</span>
  <span class="k">def</span> <span class="nf">providesFooService</span><span class="p">:</span> <span class="nc">FooService</span> <span class="o">=</span> <span class="o">???</span>

  <span class="cm">/**  Java-friendly way to access this module as a singleton instance */</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">():</span> <span class="bp">this</span><span class="p">.</span><span class="k">type</span> <span class="o">=</span> <span class="bp">this</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You could define an <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">google</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Module</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>

<span class="k">object</span> <span class="nc">MyAppMain</span> <span class="k">extends</span> <span class="nc">MyApp</span>

<span class="k">class</span> <span class="nc">MyApp</span>
  <span class="k">extends</span> <span class="nc">App</span> <span class="p">{</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">modules</span><span class="p">:</span> <span class="nc">Seq</span><span class="p">[</span><span class="nc">Module</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span><span class="nc">MyModule1</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Core app logic goes here.</span>
    <span class="kd">val</span> <span class="n">fooService</span> <span class="o">=</span> <span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">FooService</span><span class="p">]</span>
    <span class="o">???</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="java-example">
<h2>Java Example<a class="headerlink" href="#java-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.google.inject.Module</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.twitter.inject.app.AbstractApp</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">AbstractApp</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Module</span><span class="o">&gt;</span> <span class="nf">javaModules</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Module</span><span class="o">&gt;</span><span class="n">singletonList</span><span class="p">(</span><span class="n">MyModule1</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Core app logic goes here.</span>
        <span class="n">FooService</span> <span class="n">fooService</span> <span class="o">=</span>
          <span class="n">injector</span><span class="p">().</span><span class="na">instance</span><span class="p">(</span><span class="n">FooService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then create a “main” class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyAppMain</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="nf">MyAppMain</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">new</span> <span class="n">MyApp</span><span class="p">().</span><span class="na">main</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See the Finatra <a class="reference external" href="https://github.com/twitter/finatra/tree/develop/examples">examples</a> for detailed examples with tests.</p>
</section>
<section id="app-run">
<h2><cite>App#run</cite><a class="headerlink" href="#app-run" title="Permalink to this headline">¶</a></h2>
<p>The single point of entry to the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> is the <code class="docutils literal notranslate"><span class="pre">#run</span></code> method.</p>
<p>The Finatra <a class="reference external" href="../getting-started/lifecycle.html#startup">Startup Lifecycle</a> ensures that the injector
will be properly configured before access and provides the <code class="docutils literal notranslate"><span class="pre">#run</span></code> method as the function for implementing
the app.</p>
</section>
<section id="using-injection">
<h2>Using Injection<a class="headerlink" href="#using-injection" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> exposes access to the configured <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/main/scala/com/twitter/inject/Injector.scala">c.t.inject.Injector</a> which can be used to obtain instances from
the object graph.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should take care to only access the injector in the <cite>App#run</cite> function as this is the correct place in the
<a class="reference external" href="../getting-started/lifecycle.html#c-t-app-app-lifecycle">lifecycle</a> where you are ensured to have a fully
configured <cite>c.t.inject.Injector</cite>. Accessing the <cite>c.t.inject.Injector</cite> too early in the lifecycle (before it is
configured) will result in an Exception being thrown.</p>
</div>
</section>
<section id="an-example-of-handling-signals">
<h2>An Example of Handling Signals<a class="headerlink" href="#an-example-of-handling-signals" title="Permalink to this headline">¶</a></h2>
<p>There may be cases where you want your application to handle an
<a class="reference external" href="https://en.wikipedia.org/wiki/Signal_(IPC)">IPC signal</a> instead of closing normally
once the code execution is done, e.g., handling an <cite>INT</cite> (Ctrl-C) or <cite>TSTP</cite> (Ctrl-Z) signal.</p>
<p>You can use the
<a class="reference external" href="https://github.com/twitter/util/blob/aaa3d6e2bf37a3bd565a8c51187fd9b6db8a0b25/util-core/src/main/scala/com/twitter/util/Signal.scala#L75">com.twitter.util.HandleSignal</a> utility to apply a callback to run on receiving
the signal.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please consult the scaladocs for <a class="reference external" href="https://github.com/twitter/util/blob/aaa3d6e2bf37a3bd565a8c51187fd9b6db8a0b25/util-core/src/main/scala/com/twitter/util/Signal.scala#L75">com.twitter.util.HandleSignal</a>
to make sure you are aware of the limitations of the code in handling signals.</p>
</div>
<p>For example, to exit the application upon receiving an <cite>INT</cite> signal:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">google</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Module</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>

<span class="k">object</span> <span class="nc">MyAppMain</span> <span class="k">extends</span> <span class="nc">MyApp</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nc">App</span>  <span class="p">{</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">modules</span><span class="p">:</span> <span class="nc">Seq</span><span class="p">[</span><span class="nc">Module</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span><span class="nc">MyModule1</span><span class="p">)</span>

  <span class="nc">HandleSignal</span><span class="p">(</span><span class="s">&quot;INT&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">signal</span> <span class="o">=&gt;</span>
    <span class="n">exitOnError</span><span class="p">(</span><span class="s">s&quot;Process is being terminated with signal </span><span class="si">$</span><span class="n">signal</span><span class="s">.&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Core app logic goes here.</span>
    <span class="kd">val</span> <span class="n">fooService</span> <span class="o">=</span> <span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">FooService</span><span class="p">]</span>
    <span class="o">???</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="an-example-of-handling-console-output">
<h2>An Example of Handling Console Output<a class="headerlink" href="#an-example-of-handling-console-output" title="Permalink to this headline">¶</a></h2>
<p>There may be cases where your application needs to output information to the console, such as when you are
writing a command-line utility that prints its result when a computation has finished. There are some gotchas
to making console output testable, so Finatra has exposed a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/console/ConsoleWriter.scala">ConsoleWriter</a>
that can be used by both Java and Scala applications. The <cite>ConsoleWriter</cite> avoids modifying global JVM state, as modifying
<cite>System.setOut()</cite> and/or <cite>System.setErr()</cite> may result in flaky tests.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Finatra exposes Logging integrations, which are a separate concern from the <cite>ConsoleWriter</cite>. The output
of a Logger may not be appropriate for a command-line utility. The testing/binding of a <cite>Logger</cite>
is currently beyond the scope of the <cite>ConsoleWriter</cite>. Additionally, <cite>Logger</cite> configuration is
extremely flexible and there are no guarantees of messages reaching the console.</p>
<p>For more information on logging with Finatra see: <a class="reference external" href="../logging/index.html#introduction-to-logging-with-finatra">Introduction to Logging With Finatra</a>.</p>
</div>
<p>If your implementation is in Scala, the <cite>ConsoleWriter</cite> acts
as a drop in replacement that allows for capturing any <cite>scala.Console</cite> output (i.e. via <cite>println()</cite>) within the
<cite>c.t.inject.app.App#run()</cite> method via the <a class="reference external" href="#testconsolewriter">TestConsoleWriter</a> without explicit use of the <cite>ConsoleWriter</cite>.</p>
<p>For example,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">console</span><span class="p">.</span><span class="nc">ConsoleWriter</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nc">App</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">console</span> <span class="o">=</span> <span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">ConsoleWriter</span><span class="p">]</span>
    <span class="n">console</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">)</span>
    <span class="n">console</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Oops!&quot;</span><span class="p">)</span>
    <span class="c1">// println(&quot;Hello, World!&quot;) will be forwarded to `console`</span>
    <span class="c1">// Console.out.println(&quot;Hello, World!&quot;) will be forwarded to `console`</span>
    <span class="c1">// System.out.println(&quot;Hello, World!&quot;) will NOT be forwarded to `console`</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If your implementation is in Java, the <cite>System.out</cite> and <cite>System.err</cite> calls will not be forwarded
to the <cite>ConsoleWriter</cite> automatically, due to their previously mentioned coupling to global JVM state.
For Java users, it would be preferred to have expected console output of the <cite>c.t.inject.app.App#run()</cite>
method use the <cite>ConsoleWriter</cite> directly.</p>
<p>For example:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.twitter.inject.app.AbstractApp</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.twitter.inject.console.ConsoleWriter</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">AbstractApp</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Core app logic goes here.</span>
        <span class="n">ConsoleWriter</span> <span class="n">console</span> <span class="o">=</span>
          <span class="n">injector</span><span class="p">().</span><span class="na">instance</span><span class="p">(</span><span class="n">ConsoleWriter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">console</span><span class="p">.</span><span class="na">out</span><span class="p">().</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span>
        <span class="n">console</span><span class="p">.</span><span class="na">err</span><span class="p">().</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Oops!&quot;</span><span class="p">);</span>
        <span class="c1">// System.out.println(&quot;Hello, World!&quot;) will NOT be forwarded to `console`</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See <a class="reference external" href="#testconsolewriter">TestConsoleWriter</a> for testing and verifying <cite>ConsoleWriter</cite> output.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>First extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/test/scala/com/twitter/inject/Test.scala"><cite>c.t.inject.Test</cite></a> trait. Then to test, wrap your <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> with an <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/test/scala/com/twitter/inject/app/EmbeddedApp.scala">c.t.inject.app.EmbeddedApp</a>.</p>
<p>For example,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Test</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">EmbeddedApp</span>

<span class="k">class</span> <span class="nc">MyAppTest</span> <span class="k">extends</span> <span class="nc">Test</span> <span class="p">{</span>

  <span class="c1">// build an EmbeddedApp</span>
  <span class="k">def</span> <span class="nf">app</span><span class="p">():</span> <span class="nc">EmbeddedApp</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyApp</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">underlying</span><span class="p">:</span> <span class="nc">MyApp</span><span class="p">):</span> <span class="nc">EmbeddedApp</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedApp</span><span class="p">(</span><span class="n">underlying</span><span class="p">).</span><span class="n">bind</span><span class="p">[</span><span class="nc">Foo</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="k">new</span> <span class="nc">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;MyApp#run&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">app</span><span class="p">().</span><span class="n">main</span><span class="p">(</span><span class="s">&quot;username&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;jack&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;MyApp#works as expected&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// create a version of the app local to this test</span>
    <span class="c1">// here we could change the configuration of the app under test</span>
    <span class="kd">val</span> <span class="n">localTestInstanceApp</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyApp</span><span class="p">)</span>
    <span class="n">localTestInstanceApp</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="s">&quot;username&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;jill&quot;</span><span class="p">)</span>

    <span class="c1">// expect behavior against instances from the `localTestInstanceApp` injector</span>
    <span class="n">localTestInstanceApp</span><span class="p">.</span><span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">Foo</span><span class="p">].</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span><span class="p">(</span><span class="nc">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and in Java:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.*</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Assert</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.twitter.inject.app.EmbeddedApp</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyAppTest</span> <span class="kd">extends</span> <span class="n">Assert</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">EmbeddedApp</span> <span class="nf">app</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">app</span><span class="p">(</span><span class="k">new</span> <span class="n">MyApp</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="n">EmbeddedApp</span> <span class="nf">app</span><span class="p">(</span><span class="n">MyApp</span> <span class="n">underlying</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">EmbeddedApp</span><span class="p">(</span><span class="n">underlying</span><span class="p">).</span><span class="na">bindClass</span><span class="p">(</span><span class="n">Foo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">Foo</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRun</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">flags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>
      <span class="n">flags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="s">&quot;jack&quot;</span><span class="p">);</span>

      <span class="n">app</span><span class="p">().</span><span class="na">main</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWorksAsExpected</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">flags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>
      <span class="n">flags</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="s">&quot;jill&quot;</span><span class="p">);</span>

      <span class="c1">// create a version of the app local to this test</span>
      <span class="c1">// here we could change the configuration of the app under test</span>
      <span class="n">MyApp</span> <span class="n">localTestInstanceApp</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="k">new</span> <span class="n">MyApp</span><span class="p">());</span>
      <span class="n">app</span><span class="p">(</span><span class="n">localTestInstanceApp</span><span class="p">).</span><span class="na">main</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

      <span class="c1">// expect behavior against instances from the `localTestInstanceApp` injector</span>
      <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">localTestInstanceApp</span><span class="p">.</span><span class="na">injector</span><span class="p">().</span><span class="na">instance</span><span class="p">(</span><span class="n">Foo</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
      <span class="n">assertEquals</span><span class="p">(</span><span class="cm">/* expected */</span> <span class="n">Foo</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="cm">/* actual */</span> <span class="n">foo</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Note: every call to <cite>EmbeddedApp#main</cite> will run the application with the given flags. If your application is stateful,
you may want to ensure that a new instance of your application under test is created per test run, like written above.</p>
</div>
<p>There may be cases where you want to assert some metrics are written by your application for the purpose of testing functionality, even though your application may not export them for collection.</p>
</section>
<section id="testconsolewriter">
<h2>TestConsoleWriter<a class="headerlink" href="#testconsolewriter" title="Permalink to this headline">¶</a></h2>
<p>Finatra provides a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/internal/ConsoleWriterModule.scala">ConsoleWriterModule</a> which will bind the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/console/ConsoleWriter.scala">ConsoleWriter</a> to the object graph.
The <cite>ConsoleWriter</cite> can be bound for testing with the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/test/scala/com/twitter/inject/app/TestConsoleWriter.scala">TestConsoleWriter</a> in order to inspect the console output of a command-line style <cite>App</cite>.</p>
<p>Assuming you have an App:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nn">console</span><span class="p">.</span><span class="nc">ConsoleWriter</span>

<span class="k">object</span> <span class="nc">MyAppMain</span> <span class="k">extends</span> <span class="nc">MyApp</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nc">App</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Core app logic goes here.</span>
    <span class="kd">val</span> <span class="n">console</span> <span class="o">=</span> <span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">ConsoleWriter</span><span class="p">]</span>
    <span class="n">console</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">)</span>

    <span class="c1">// output to the Scala `Console` will also be captured, the following would be equivalent:</span>
    <span class="c1">// Console.out.println(&quot;Hello, World!&quot;)</span>
    <span class="c1">// println(&quot;Hello, World!&quot;)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and in Java:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.twitter.inject.app.AbstractApp</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.twitter.inject.console.ConsoleWriter</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">AbstractApp</span> <span class="p">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Core app logic goes here.</span>
        <span class="n">ConsoleWriter</span> <span class="n">console</span> <span class="o">=</span>
          <span class="n">injector</span><span class="p">().</span><span class="na">instance</span><span class="p">(</span><span class="n">ConsoleWriter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="n">console</span><span class="p">.</span><span class="na">out</span><span class="p">().</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span>
        <span class="c1">// System.out.println(&quot;Hello, World!&quot;); will NOT be captured for testing</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You could then test emitted console output like so:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Test</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">EmbeddedApp</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">TestConsoleWriter</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nn">console</span><span class="p">.</span><span class="nc">ConsoleWriter</span>

<span class="k">class</span> <span class="nc">MyAppTest</span> <span class="k">extends</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="n">console</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestConsoleWriter</span><span class="p">()</span>
  <span class="c1">// build an EmbeddedApp</span>
  <span class="k">def</span> <span class="nf">app</span><span class="p">():</span> <span class="nc">EmbeddedApp</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyApp</span><span class="p">).</span><span class="n">bind</span><span class="p">[</span><span class="nc">ConsoleWriter</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">beforeEach</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">console</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="bp">super</span><span class="p">.</span><span class="n">beforeEach</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;assert count&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">undertest</span> <span class="o">=</span> <span class="n">app</span><span class="p">()</span>
    <span class="n">undertest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">console</span><span class="p">.</span><span class="n">inspectOut</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Hello, World!\n&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and in Java:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.twitter.inject.app.EmbeddedApp</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.twitter.inject.app.TestConsoleWriter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.twitter.inject.app.console.ConsoleWriter</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">junit.Assert</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">junit.Test</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyAppTest</span> <span class="kd">extends</span> <span class="n">Assert</span> <span class="p">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testOutput</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">TestConsoleWriter</span> <span class="n">console</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestConsoleWriter</span><span class="p">();</span>
    <span class="n">EmbeddedApp</span> <span class="n">app</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EmbeddedApp</span><span class="p">(</span><span class="n">myApp</span><span class="p">).</span><span class="na">bindClass</span><span class="p">(</span><span class="n">ConsoleWriter</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">console</span><span class="p">);</span>
    <span class="n">app</span><span class="p">.</span><span class="na">main</span><span class="p">();</span>
    <span class="n">assertEquals</span><span class="p">(</span><span class="n">console</span><span class="p">.</span><span class="na">inspectOut</span><span class="p">(),</span> <span class="s">&quot;Hello, World!\n&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="inmemorystatsreceiver">
<h2>InMemoryStatsReceiver<a class="headerlink" href="#inmemorystatsreceiver" title="Permalink to this headline">¶</a></h2>
<p>Finatra prodives a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-modules/src/main/scala/com/twitter/inject/modules/StatsReceiverModule.scala">StatsReceiverModule</a> which will bind the <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/stats/LoadedStatsReceiver.scala">LoadedStatsReceiver</a> to the object graph.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Finagle uses service-loading to allow for users to pick their <cite>com.twitter.finagle.stats.StatsReceiver</cite> implementation. We recommend
using Twitter’s <a class="reference external" href="https://twitter.github.io/util/guide/util-stats/index.html">util-stats</a> implementation
which will be service-loaded as the implementation of <cite>LoadedStatsReceiver</cite> if the dependency is on your
classpath.</p>
</div>
<p>Finagle provides an <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-stats/src/main/scala/com/twitter/finagle/stats/InMemoryStatsReceiver.scala">com.twitter.finagle.stats.InMemoryStatsReceiver</a>
which stores metrics in an in-memory Map to make it simple to query and assert their values. You can bind an instance of the <cite>InMemoryStatsReceiver</cite> to the underlying app’s object graph as the implementation of the app’s <cite>StatsReceiver</cite> when testing to be able to assert metrics emitted by the application.</p>
<p>Assuming you have an App:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">google</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Module</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nn">stats</span><span class="p">.</span><span class="nc">StatsReceiver</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">modules</span><span class="p">.</span><span class="nc">StatsReceiverModule</span>

<span class="k">object</span> <span class="nc">MyAppMain</span> <span class="k">extends</span> <span class="nc">MyApp</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nc">App</span> <span class="p">{</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">modules</span><span class="p">:</span> <span class="nc">Seq</span><span class="p">[</span><span class="nc">Module</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span>
    <span class="nc">StatsReceiverModule</span>
    <span class="nc">MyModule1</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Core app logic goes here.</span>
    <span class="kd">val</span> <span class="n">statsReceiver</span> <span class="o">=</span> <span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">StatsReceiver</span><span class="p">]</span>
    <span class="n">statsReceiver</span><span class="p">.</span><span class="n">counter</span><span class="p">(</span><span class="s">&quot;my_counter&quot;</span><span class="p">).</span><span class="n">incr</span><span class="p">()</span>
    <span class="kd">val</span> <span class="n">fooService</span> <span class="o">=</span> <span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">FooService</span><span class="p">]</span>
    <span class="o">???</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You could then test emitted metrics like so:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nn">stats</span><span class="p">.</span><span class="nc">InMemoryStatsReceiver</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Test</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">EmbeddedApp</span>

<span class="k">class</span> <span class="nc">MyAppTest</span> <span class="k">extends</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="n">inMemoryStatsReceiver</span><span class="p">:</span> <span class="nc">InMemoryStatsReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryStatsReceiver</span>

  <span class="c1">// build an EmbeddedApp</span>
  <span class="k">def</span> <span class="nf">app</span><span class="p">():</span> <span class="nc">EmbeddedApp</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="k">new</span> <span class="nc">MyApp</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">underlying</span><span class="p">:</span> <span class="nc">MyApp</span><span class="p">):</span> <span class="nc">EmbeddedApp</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedApp</span><span class="p">(</span><span class="n">underlying</span><span class="p">)</span>
      <span class="p">.</span><span class="n">bind</span><span class="p">[</span><span class="nc">Foo</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="k">new</span> <span class="nc">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
      <span class="p">.</span><span class="n">bind</span><span class="p">[</span><span class="nc">StatsReceiver</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="n">inMemoryStatsReceiver</span><span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;assert count&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">undertest</span> <span class="o">=</span> <span class="n">app</span><span class="p">()</span>
    <span class="n">undertest</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="s">&quot;username&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;jack&quot;</span><span class="p">)</span>

    <span class="kd">val</span> <span class="n">statsReceiver</span> <span class="o">=</span> <span class="n">undertest</span><span class="p">.</span><span class="n">injector</span><span class="p">.</span><span class="n">instance</span><span class="p">[</span><span class="nc">StatsReceiver</span><span class="p">].</span><span class="k">asInstanceOf</span><span class="p">[</span><span class="nc">InMemoryStatsReceiver</span><span class="p">]</span>
    <span class="n">statsReceiver</span><span class="p">.</span><span class="n">counter</span><span class="p">(</span><span class="s">&quot;my_counter&quot;</span><span class="p">)()</span> <span class="n">shouldEqual</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For more information on the Embedded testing utilities, including on testing with <a class="reference external" href="../testing/embedded.html#testing-with-global-flags">GlobalFlags</a> see the documentation <a class="reference external" href="../testing/embedded.html">here</a>. Also see the documentation for more information on the <a class="reference external" href="../testing/bind_dsl.html">#bind[T] DSL</a> used above.</p>
<p>And lastly, for the complete testing guide, see the Testing <a class="reference external" href="../#testing">table of contents</a>.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Creating an injectable <cite>util-app App</cite></a><ul>
<li><a class="reference internal" href="#lifecycle">Lifecycle</a></li>
<li><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li><a class="reference internal" href="#scala-example">Scala Example</a></li>
<li><a class="reference internal" href="#java-example">Java Example</a></li>
<li><a class="reference internal" href="#app-run"><cite>App#run</cite></a></li>
<li><a class="reference internal" href="#using-injection">Using Injection</a></li>
<li><a class="reference internal" href="#an-example-of-handling-signals">An Example of Handling Signals</a></li>
<li><a class="reference internal" href="#an-example-of-handling-console-output">An Example of Handling Console Output</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#testconsolewriter">TestConsoleWriter</a></li>
<li><a class="reference internal" href="#inmemorystatsreceiver">InMemoryStatsReceiver</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="../logging/asyncappender.html" title="previous chapter">Custom Logback AsyncAppender</a></li>
      <li>Next: <a href="../twitter-server/index.html" title="next chapter">Creating an injectable <cite>TwitterServer</cite></a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2024 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>