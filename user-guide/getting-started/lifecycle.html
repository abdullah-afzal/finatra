
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Application and Server Lifecycle &#8212; Finatra 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/flasky.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Modules" href="modules.html" />
    <link rel="prev" title="TwitterServer Basics" href="twitter_server.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="modules.html" title="Modules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="twitter_server.html" title="TwitterServer Basics"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Application and Server Lifecycle</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="application-and-server-lifecycle">
<span id="lifecycle"></span><h1>Application and Server Lifecycle<a class="headerlink" href="#application-and-server-lifecycle" title="Permalink to this headline">¶</a></h1>
<p>Finatra establishes an ordered lifecycle when creating a <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/App.html">c.t.app.App</a> or
a <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala">c.t.server.TwitterServer</a>
and provides methods which can be implemented for running or starting core logic.</p>
<p>This is done for several reasons:</p>
<ul class="simple">
<li><p>To ensure that <a class="reference external" href="./flags.html">flag</a> parsing and <a class="reference external" href="./modules.html">module</a> installation to
build the object graph is done in the correct order such that the injector is properly configured
before a user attempts attempts to access flags.</p></li>
<li><p>Ensure that object promotion and garbage collection is properly handled <em>before</em> accepting traffic
to a server.</p></li>
<li><p>Expose any external interface <em>before</em> reporting a server is “healthy”. Otherwise a server may
report it is healthy before binding to a port — which may fail. Depending on how monitoring is
configured (typically done by monitoring the <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#admin-http-interface">HTTP Admin Interface</a>
<a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#lifecycle-management">/health</a> endpoint
on some frequency) it could be some interval before the server is recognized as unhealthy when in
fact it did not start properly as it could not bind to a port.</p></li>
</ul>
<p>Thus you do not have access to the <a class="reference external" href="https://github.com/twitter/util/blob/9fa550a269d2287b24e94921a352ba954f9f4bfb/util-app/src/main/scala/com/twitter/app/App.scala#L24">App</a>
or <a class="reference external" href="https://github.com/twitter/twitter-server/blob/5fea9c2a6220ab9bbdb449c99c946e2aef322e7d/server/src/main/scala/com/twitter/server/TwitterServer.scala#L93">TwitterServer</a>
<cite>main()</cite> method. Instead, any logic should be contained in overriding an <code class="docutils literal notranslate"><span class="pre">&#64;Lifecycle</span></code>-annotated
method or in the application or server callbacks.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>If you override an <code class="docutils literal notranslate"><span class="pre">&#64;Lifecycle</span></code>-annotated method you <strong>MUST</strong> first call
<cite>super.lifecycleMethod()</cite> in your override to ensure that framework lifecycle events happen
accordingly.</p>
</div>
<section id="choosing-between-twitterserver-and-app">
<h2>Choosing between TwitterServer and App<a class="headerlink" href="#choosing-between-twitterserver-and-app" title="Permalink to this headline">¶</a></h2>
<p>See the <a class="reference external" href="./comparison.html">TwitterServer v. App comparison chart</a> to decide
between an App or TwitterServer.</p>
<p>See the <a class="reference external" href="../app/index.html">Creating an injectable App</a> and
<a class="reference external" href="../twitter-server/index.html">Creating an injectable TwitterServer</a> sections for more information.</p>
</section>
<section id="c-t-app-app-lifecycle">
<h2><a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> Lifecycle<a class="headerlink" href="#c-t-app-app-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Finatra servers are, at their base, <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> applications. Therefore it will help to first
cover the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> lifecycle.</p>
<p>When writing a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a>, you extend the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> trait and place your application logic
inside of a public <cite>main()</cite> method.</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nc">App</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">n</span> <span class="o">=</span> <span class="n">flag</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">&quot;Number of items to process&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">main</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="n">n</span><span class="p">())</span> <span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> provides ways to tie into it’s lifecycle by allowing the user to register logic for
different lifecycle phases. E.g., to run logic in the <cite>init</cite> lifecycle phase, the user can call
the <cite>init</cite> function passing a callback to run. <cite>App</cite> collects every call to the <cite>init</cite> function and
will run the callbacks in the order added during the <cite>init</cite> lifecycle phase.</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">app</span><span class="p">.</span><span class="nc">App</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="k">extends</span> <span class="nc">App</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="c1">// initialization logic</span>
    <span class="p">}</span>

    <span class="n">premain</span> <span class="p">{</span>
        <span class="c1">// logic to run right before main()</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">main</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// your application logic here</span>
    <span class="p">}</span>

    <span class="n">postmain</span> <span class="p">{</span>
        <span class="c1">// logic to run right after main()</span>
    <span class="p">}</span>

    <span class="n">onExit</span> <span class="p">{</span>
        <span class="c1">// closing logic</span>
    <span class="p">}</span>

    <span class="n">closeOnExitLast</span><span class="p">(</span><span class="nc">MyClosable</span><span class="p">)</span> <span class="c1">// final closing logic</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Additional hooks are <cite>premain</cite>, <cite>postmain</cite>, <cite>onExit</cite> and <cite>closeOnExitLast()</cite>, as shown above.</p>
<p>The lifecycle could thus be represented:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>App#main<span class="o">()</span> --&gt;
App#nonExitingMain<span class="o">()</span> --&gt;
    <span class="nb">bind</span> LoadService bindings
    run all init <span class="o">{}</span> blocks
    App#parseArgs<span class="o">()</span> // <span class="nb">read</span> <span class="nb">command</span> line args into Flags
    run all premain <span class="o">{}</span> blocks
    run all defined main<span class="o">()</span> methods
    run all postmain <span class="o">{}</span> blocks
    App#close<span class="o">()</span> --&gt;
        run all onExit <span class="o">{}</span> blocks
        run all Closables registered via closeOnExitLast<span class="o">()</span>
</pre></div>
</div>
</section>
<section id="c-t-inject-app-app-lifecycle">
<h2><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> Lifecycle<a class="headerlink" href="#c-t-inject-app-app-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>The Finatra <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> extends the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> lifecycle by adding more structure to the
defined <cite>main()</cite> method.</p>
<p>The lifecycle for a Finatra “injectable” App <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a> can be described:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>App#main<span class="o">()</span> --&gt;
App#nonExitingMain<span class="o">()</span> --&gt;
    <span class="nb">bind</span> LoadService bindings
    run all init <span class="o">{}</span> blocks
    App#parseArgs<span class="o">()</span> // <span class="nb">read</span> <span class="nb">command</span> line args into Flags
    run all premain <span class="o">{}</span> blocks
    c.t.inject.app.App#main<span class="o">()</span> --&gt;
        load/install modules
        modules#postInjectorStartup<span class="o">()</span>
        postInjectorStartup<span class="o">()</span>
        warmup<span class="o">()</span>
        beforePostWarmup<span class="o">()</span>
        postWarmup<span class="o">()</span>
        afterPostwarmup<span class="o">()</span>
        modules#postWarmupComplete<span class="o">()</span>
        register application started
        c.t.inject.app.App#run<span class="o">()</span>
    run all postmain <span class="o">{}</span> blocks
    App#close<span class="o">()</span> --&gt;
        run all onExit <span class="o">{}</span> blocks
        run all Closables registered via closeOnExitLast<span class="o">()</span>
</pre></div>
</div>
<p>For more information on creating an “injectable” App with Finatra, see the documentation
<a class="reference external" href="../app/index.html">here</a>.</p>
</section>
<section id="c-t-server-twitterserver-lifecycle">
<h2><a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> Lifecycle<a class="headerlink" href="#c-t-server-twitterserver-lifecycle" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> is an extension of <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> and thus inherits the <a class="reference external" href="#c-t-app-app-lifecycle">c.t.app.App lifecycle</a>,
but adds the ability to include “warmup” lifecycle phases which are just a refinement of
the defined <cite>main()</cite> phase of the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> lifecycle. That is, the
<a class="reference external" href="https://github.com/twitter/twitter-server/blob/7d59c1bd46b2d96e4d0056f7860ca0344fe69247/server/src/main/scala/com/twitter/server/Lifecycle.scala#L85"><cite>c.t.server.Lifecycle.Warmup</cite></a> trait exposes two methods, <cite>prebindWarmup</cite> and <cite>warmupComplete</cite>.</p>
<p>These methods are provided <strong>for the user to call</strong> when they make sense typically at points in the
user defined <cite>main()</cite> method before awaiting on the external interface.</p>
<p>The idea being that within your user defined <cite>main()</cite> method you may want to have logic to warmup
the server before accepting traffic on any defined external interface. By default the <cite>prebindWarmup</cite>
method attempts to run a <cite>System.gc</cite> in order to promote objects to old gen (in an attempt to incur a
GC pause <em>before</em> your server accepts any traffic).</p>
<p>Users then have a way to signal that warmup is done and the server is now ready to start
accepting traffic. This is done by calling <cite>warmupComplete()</cite>.</p>
<p>To add these phases, users would mix-in the <a class="reference external" href="https://github.com/twitter/twitter-server/blob/7d59c1bd46b2d96e4d0056f7860ca0344fe69247/server/src/main/scala/com/twitter/server/Lifecycle.scala#L85"><cite>c.t.server.Lifecycle.Warmup</cite></a> trait into their
<a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> extension.</p>
</section>
<section id="c-t-inject-server-twitterserver-lifecycle">
<h2><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala"><cite>c.t.inject.server.TwitterServer</cite></a> Lifecycle<a class="headerlink" href="#c-t-inject-server-twitterserver-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Finatra defines an “injectable” TwitterServer, <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala"><cite>c.t.inject.server.TwitterServer</cite></a> which itself is an
extension of <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> and the Finatra “injectable” App, <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala"><cite>c.t.inject.app.App</cite></a>.</p>
<p>The Finatra “injectable” TwitterServer, <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala"><cite>c.t.inject.server.TwitterServer</cite></a> mixes in the
<a class="reference external" href="https://github.com/twitter/twitter-server/blob/7d59c1bd46b2d96e4d0056f7860ca0344fe69247/server/src/main/scala/com/twitter/server/Lifecycle.scala#L85"><cite>c.t.server.Lifecycle.Warmup</cite></a> trait by default to ensure that warmup is performed where most applicable
and further refines the warmup lifecycle as described in the next section.</p>
<p>For more information on creating an “injectable” TwitterServer with Finatra, see the documentation
<a class="reference external" href="../twitter-server/index.html">here</a>.</p>
<section id="server-startup-lifecycle">
<h3>Server Startup Lifecycle<a class="headerlink" href="#server-startup-lifecycle" title="Permalink to this headline">¶</a></h3>
<p>Finatra servers inherit the <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a> lifecycle and, as mentioned, also mix-in the TwitterServer
<a class="reference external" href="https://github.com/twitter/twitter-server/blob/7d59c1bd46b2d96e4d0056f7860ca0344fe69247/server/src/main/scala/com/twitter/server/Lifecycle.scala#L85"><cite>c.t.server.Lifecycle.Warmup</cite></a> trait. On top of that, Finatra further refines the lifecycle by adding
more defined phases. These phases all run within a defined <cite>main()</cite> and thus in the “main” <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-app/src/main/scala/com/twitter/app/App.scala"><cite>c.t.app.App</cite></a>
lifecycle phase and is intended to ensure that the underlying dependency injection framework is
properly instantiated, all Twitter Util <a class="reference external" href="./flags.html">Flags</a> are properly parsed, external
interfaces are properly bound and the application is correctly started with minimal intervention
needed on the part of the implementor.</p>
<p>In text, at a high-level, the start-up lifecycle of a Finatra server looks like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>App#main<span class="o">()</span> --&gt;
App#nonExitingMain<span class="o">()</span> --&gt;
    <span class="nb">bind</span> LoadService bindings
    run all init <span class="o">{}</span> blocks
    App#parseArgs<span class="o">()</span> // <span class="nb">read</span> <span class="nb">command</span> line args into Flags
    run all premain <span class="o">{}</span> blocks --&gt;
        add routes to TwitterServer AdminHttpServer
        <span class="nb">bind</span> interface and start TwitterServer AdminHttpServer
    c.t.inject.server.TwitterServer#main<span class="o">()</span> --&gt;
        c.t.inject.app.App#main<span class="o">()</span> --&gt;
            load/install modules
            modules#postInjectorStartup<span class="o">()</span>
            postInjectorStartup<span class="o">()</span> --&gt;
                resolve finagle clients
                setup<span class="o">()</span>
            warmup<span class="o">()</span>
            beforePostWarmup<span class="o">()</span> --&gt;
                Lifecycle#prebindWarmup<span class="o">()</span>
            postWarmup<span class="o">()</span> --&gt;
                announce TwitterServer AdminHttpServer interface
                <span class="nb">bind</span> external interfaces
                announce external interfaces
            afterPostwarmup<span class="o">()</span> --&gt;
                Lifecycle#warmupComplete<span class="o">()</span>
            modules#postWarmupComplete<span class="o">()</span>
            register application started
            c.t.inject.app.App#run<span class="o">()</span> --&gt;
                c.t.inject.server.TwitterServer#start<span class="o">()</span>
        block on awaitables
    run all postmain <span class="o">{}</span> blocks
    App#close<span class="o">()</span> --&gt;
        run all onExit <span class="o">{}</span> blocks
        run all Closables registered via closeOnExitLast<span class="o">()</span>
</pre></div>
</div>
<p>Visually:</p>
<img alt="../../_images/FinatraLifecycle.png" src="../../_images/FinatraLifecycle.png" />
</section>
<section id="server-shutdown-lifecycle">
<h3>Server Shutdown Lifecycle<a class="headerlink" href="#server-shutdown-lifecycle" title="Permalink to this headline">¶</a></h3>
<p>Upon <em>graceful</em> shutdown of an application or a server, all registered <cite>onExit</cite>, <cite>closeOnExit</cite>, and
<cite>closeOnExitLast</cite> blocks are executed. See
<a class="reference external" href="https://github.com/twitter/util/blob/9fa550a269d2287b24e94921a352ba954f9f4bfb/util-app/src/main/scala/com/twitter/app/App.scala#L72">c.t.app.App#exits</a>
and <a class="reference external" href="https://github.com/twitter/util/blob/bf47b55ff45a31bbd541f66257f2244df5c35f5b/util-app/src/main/scala/com/twitter/app/App.scala#L86">c.t.app.App#lastExits</a>.</p>
<p>For a server, this includes closing the <a class="reference external" href="https://github.com/twitter/twitter-server">TwitterServer</a>
<a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#admin-http-interface">HTTP Admin Interface</a>
and shutting down and closing all installed modules. For extensions of the
<a class="reference external" href="../http/server.html">HttpServer</a> or <a class="reference external" href="../thrift/server.html">ThriftServer</a> traits this also
includes closing any external interfaces.</p>
<div class="admonition-important admonition">
<p class="admonition-title">Important</p>
<p>Note that the order of execution for all registered <cite>onExit</cite> and <cite>closeOnExit</cite> blocks is not
guaranteed as they are executed on graceful shutdown roughly in parallel. Thus it is up to
implementors to enforce any desired ordering.</p>
</div>
<p>For example, you have code which is reading from a queue (via a “subscriber”), transforming the
data, and then publishing (via a “publisher”) to another queue. When the main application is exiting
you most likely want to close the “subscriber” first to ensure that you transform and publish all
available data before closing the “publisher”.</p>
<p>Assuming, that both objects are a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Closable.scala"><cite>c.t.util.Closable</cite></a> type, a simple way to close them would be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">closeOnExit</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
<span class="n">closeOnExit</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
</pre></div>
</div>
<p>However, the “subscriber” and the “publisher” would close roughly in parallel
which could lead to data inconsistencies in your server if the “subscriber” is still reading before
the “publisher” has closed.</p>
<section id="ordering-onexit-and-closeonexit-functions">
<h4>Ordering <cite>onExit</cite> and <cite>closeOnExit</cite> functions?<a class="headerlink" href="#ordering-onexit-and-closeonexit-functions" title="Permalink to this headline">¶</a></h4>
<p>Assuming, that the <cite>#close()</cite> method of both returns <cite>Future[Unit]</cite>, e.g. like a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Closable.scala"><cite>c.t.util.Closable</cite></a>,
a way of doing this could be:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">onExit</span> <span class="p">{</span>
  <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">subscriber</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">defaultCloseGracePeriod</span><span class="p">))</span>
  <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">publisher</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">defaultCloseGracePeriod</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where the <cite>defaultCloseGracePeriod</cite> is the <a class="reference external" href="https://github.com/twitter/util/blob/bf47b55ff45a31bbd541f66257f2244df5c35f5b/util-app/src/main/scala/com/twitter/app/App.scala#L110">c.t.app.App#defaultCloseGracePeriod</a>
function.</p>
<p>In the above example we simply await on the <cite>#close()</cite> of the “subscriber” first and then the
<cite>#close()</cite> of the “publisher” thus ensuring that the “subscriber” will close before the “publisher”.</p>
<p>However, we are not providing a timeout to the <cite>Await.result</cite>, which we should ideally do as
well since we do not want to accidentally block our server shutdown if the <cite>defaultCloseGracePeriod</cite>
is set to something high or infinite (e.g., <a class="reference external" href="https://github.com/twitter/util/blob/bf47b55ff45a31bbd541f66257f2244df5c35f5b/util-core/src/main/scala/com/twitter/util/Time.scala#L302">Time.Top</a>).</p>
<p>But if we don’t know the configured value of the  <cite>defaultCloseGracePeriod</cite> this makes things
complicated. We could just hardcode a value for the Await, or not use the <cite>defaultCloseGracePeriod</cite>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">onExit</span> <span class="p">{</span>
  <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">subscriber</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">defaultCloseGracePeriod</span><span class="p">),</span> <span class="mi">5</span><span class="p">.</span><span class="n">seconds</span><span class="p">)</span>
  <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">publisher</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">defaultCloseGracePeriod</span><span class="p">),</span> <span class="mi">5</span><span class="p">.</span><span class="n">seconds</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="n">onExit</span> <span class="p">{</span>
  <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">subscriber</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="n">seconds</span><span class="p">),</span> <span class="mi">5</span><span class="p">.</span><span class="n">seconds</span><span class="p">)</span>
  <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">publisher</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="n">seconds</span><span class="p">),</span> <span class="mi">5</span><span class="p">.</span><span class="n">seconds</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>However, this is obviously not ideal and there is an easier way. You can enforce the ordering of
closing Closables by using <cite>closeOnExitLast</cite>.</p>
<p>A <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Closable.scala"><cite>c.t.util.Closable</cite></a> passed to <cite>closeOnExitLast</cite> will be closed <em>after</em> all <cite>onExit</cite> and
<cite>closeOnExit</cite> functions are executed. E.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">closeOnExit</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
<span class="n">closeOnExitLast</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
</pre></div>
</div>
<p>In this code the “publisher” is guaranteed be closed <strong>after</strong> the “subscriber”.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the exit functions: <cite>onExit</cite>, <cite>closeOnExit</cite>, and <cite>closeOnExitLast</cite> use the
<cite>defaultCloseGracePeriod</cite> as their close “deadline” and will raise a <cite>TimeoutException</cite> if
all the <cite>exits</cite> (collected <cite>onExit</cite>, <cite>closeOnExit</cite> functions) do not close within the deadline.
And if the <cite>lastExits</cite> (collected <cite>closeOnExitLast</cite> functions) do not close within the deadline.</p>
</div>
<p>If you have multiple <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Closable.scala"><cite>c.t.util.Closable</cite></a> objects you want to close in parallel and one you want to
close after all the others, you could do:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">closeOnExit</span><span class="p">(</span><span class="n">subscriberA</span><span class="p">)</span>
<span class="n">closeOnExit</span><span class="p">(</span><span class="n">subscriberB</span><span class="p">)</span>
<span class="n">closeOnExit</span><span class="p">(</span><span class="n">subscriberC</span><span class="p">)</span>
<span class="n">closeOnExitLast</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
</pre></div>
</div>
<p>The “publisher” is guaranteed be closed <strong>after</strong> the closing of “subscriberA”, “subscriberB”, and
“subscriberC”.</p>
</section>
<section id="what-to-do-if-you-don-t-have-a-c-t-util-closable">
<h4>What to do if you don’t have a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Closable.scala"><cite>c.t.util.Closable</cite></a>?<a class="headerlink" href="#what-to-do-if-you-don-t-have-a-c-t-util-closable" title="Permalink to this headline">¶</a></h4>
<p>You can simply use the <cite>onExit</cite> block to perform any shutdown logic, or you can wrap a function in
a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Closable.scala"><cite>c.t.util.Closable</cite></a> to be passed to <cite>closeOnExit</cite> or <cite>closeOnExitLast</cite>.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">onExit</span> <span class="p">{</span>
   <span class="nc">DatabaseConnection</span><span class="p">.</span><span class="n">drain</span><span class="p">()</span>
   <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">someFutureOperation</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="n">seconds</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">closeOnExit</span> <span class="p">{</span>
  <span class="nc">Closable</span><span class="p">.</span><span class="n">make</span> <span class="p">{</span> <span class="n">deadline</span> <span class="o">=&gt;</span>
   <span class="n">prepWork</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
   <span class="n">anotherFutureOperation</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">closeOnExitLast</span> <span class="p">{</span>
  <span class="nc">Closable</span><span class="p">.</span><span class="n">make</span> <span class="p">{</span> <span class="n">deadline</span> <span class="o">=&gt;</span>
    <span class="n">queue</span><span class="p">.</span><span class="n">blockingStop</span><span class="p">(</span><span class="n">deadline</span><span class="p">)</span>
    <span class="nc">Future</span><span class="p">.</span><span class="nc">Unit</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also wrap multiple functions in a Closable:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">closeOnExit</span> <span class="p">{</span>
   <span class="nc">Closable</span><span class="p">.</span><span class="n">make</span> <span class="p">{</span> <span class="n">deadline</span> <span class="o">=&gt;</span>
     <span class="n">database</span><span class="p">.</span><span class="n">drain</span><span class="p">()</span>
     <span class="n">fileCleanUp</span><span class="p">.</span><span class="k">do</span><span class="p">()</span>
     <span class="n">pushData</span><span class="p">(</span><span class="n">deadline</span><span class="p">)</span>
     <span class="nc">Future</span><span class="p">.</span><span class="nc">Unit</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Again the code in <cite>onExit</cite> and <cite>closeOnExit</cite> will be run in parallel and guaranteed to close
before the functions in <cite>closeOnExitLast</cite>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Multiple <cite>closeOnExitLast</cite> Closables will be closed in parallel with each other but
<strong>after</strong> all <cite>onExit</cite> and <cite>closeOnExit</cite> functions have closed.</p>
</div>
</section>
</section>
</section>
<section id="modules">
<h2>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h2>
<p>Modules provide hooks into the Lifecycle as well that allow instances being provided to the object
graph to be plugged into the overall application or server lifecycle. See the
<a class="reference external" href="../getting-started/modules.html#module-lifecycle">Module Lifecycle</a> section for more information.</p>
</section>
<section id="more-information">
<h2>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<p>As noted in the diagram in the <a class="reference external" href="#startup">Startup</a> section the lifecycle or an application can be
non-trivial – especially in the case of a <a class="reference external" href="https://github.com/twitter/twitter-server">TwitterServer</a>.</p>
<p>For more information on how to create an injectable <a class="reference external" href="https://twitter.github.io/util/docs/com/twitter/app/App.html">c.t.app.App</a>
or a <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala">c.t.server.TwitterServer</a>
see the <a class="reference external" href="../app/index.html">Creating an injectable App</a> and
<a class="reference external" href="../twitter-server/index.html">Creating an injectable TwitterServer</a> sections.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Application and Server Lifecycle</a><ul>
<li><a class="reference internal" href="#choosing-between-twitterserver-and-app">Choosing between TwitterServer and App</a></li>
<li><a class="reference internal" href="#c-t-app-app-lifecycle"><cite>c.t.app.App</cite> Lifecycle</a></li>
<li><a class="reference internal" href="#c-t-inject-app-app-lifecycle"><cite>c.t.inject.app.App</cite> Lifecycle</a></li>
<li><a class="reference internal" href="#c-t-server-twitterserver-lifecycle"><cite>c.t.server.TwitterServer</cite> Lifecycle</a></li>
<li><a class="reference internal" href="#c-t-inject-server-twitterserver-lifecycle"><cite>c.t.inject.server.TwitterServer</cite> Lifecycle</a><ul>
<li><a class="reference internal" href="#server-startup-lifecycle">Server Startup Lifecycle</a></li>
<li><a class="reference internal" href="#server-shutdown-lifecycle">Server Shutdown Lifecycle</a><ul>
<li><a class="reference internal" href="#ordering-onexit-and-closeonexit-functions">Ordering <cite>onExit</cite> and <cite>closeOnExit</cite> functions?</a></li>
<li><a class="reference internal" href="#what-to-do-if-you-don-t-have-a-c-t-util-closable">What to do if you don’t have a <cite>c.t.util.Closable</cite>?</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#modules">Modules</a></li>
<li><a class="reference internal" href="#more-information">More Information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="twitter_server.html" title="previous chapter">TwitterServer Basics</a></li>
      <li>Next: <a href="modules.html" title="next chapter">Modules</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2024 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>