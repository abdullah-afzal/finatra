
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Feature Tests &#8212; Finatra 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/flasky.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Integration Tests" href="integration_tests.html" />
    <link rel="prev" title="Embedded Servers and Apps" href="embedded.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="integration_tests.html" title="Integration Tests"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="embedded.html" title="Embedded Servers and Apps"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Feature Tests</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="feature-tests">
<span id="id1"></span><h1>Feature Tests<a class="headerlink" href="#feature-tests" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Please see the section on including test-jar dependencies in your project: <a class="reference external" href="../..#test-dependencies">Test Dependencies</a>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are calling an <a class="reference external" href="https://github.com/twitter/util/blob/54f314d1f4b37d302f685e99b1ac416e48532a04/util-core/src/main/scala/com/twitter/util/Awaitable.scala#L77"><cite>c.t.util.Await</cite></a> function on a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Future.scala"><cite>c.t.util.Future</cite></a> return type in a
test, it is generally considered good practice to ensure that your <a class="reference external" href="https://github.com/twitter/util/blob/54f314d1f4b37d302f685e99b1ac416e48532a04/util-core/src/main/scala/com/twitter/util/Awaitable.scala#L77"><cite>c.t.util.Await</cite></a> call
includes a timeout duration, otherwise you may inadvertently cause your test to hang indefinitely
if the awaited <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-core/src/main/scala/com/twitter/util/Future.scala"><cite>c.t.util.Future</cite></a> never completes.</p>
<p>The base <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-core/src/test/scala/com/twitter/inject/TestMixin.scala">c.t.inject.TestMixin</a> exposes an <a class="reference external" href="https://github.com/twitter/finatra/blob/ea0b7a6655f4a8df84b5933c0ade19cae311c098/inject/inject-core/src/test/scala/com/twitter/inject/TestMixin.scala#L103">#await</a> function which will call <a class="reference external" href="https://github.com/twitter/util/blob/54f314d1f4b37d302f685e99b1ac416e48532a04/util-core/src/main/scala/com/twitter/util/Awaitable.scala#L127"><cite>c.t.util.Await#result</cite></a>
with a test-defined <a class="reference external" href="https://github.com/twitter/finatra/blob/ea0b7a6655f4a8df84b5933c0ade19cae311c098/inject/inject-core/src/test/scala/com/twitter/inject/TestMixin.scala#L75">default timeout</a>. This can be used in place of calling <a class="reference external" href="https://github.com/twitter/util/blob/54f314d1f4b37d302f685e99b1ac416e48532a04/util-core/src/main/scala/com/twitter/util/Awaitable.scala#L127"><cite>c.t.util.Await#result</cite></a> directly.</p>
</div>
<p>If you are familiar with <a class="reference external" href="https://docs.behat.org/en/v2.5/guides/1.gherkin.html">Gherkin</a> or
<a class="reference external" href="https://github.com/cucumber/cucumber/wiki/Feature-Introduction">Cucumber</a> or other similar
testing languages and frameworks, then <a class="reference external" href="https://wiki.documentfoundation.org/QA/Testing/Feature_Tests">Feature Testing</a>
will feel somewhat familiar. In Finatra, a <cite>FeatureTest</cite> always consists of a <strong>single</strong> configured
server under test. See the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> trait.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The <cite>server</cite> is specified as a <cite>def</cite> in the <a class="reference external" href="https://github.com/twitter/finatra/blob/c6e4716f082c0c8790d06d9e1664aacbd0c3fede/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTestMixin.scala#L24"><cite>c.t.inject.server.FeatureTestMixin</cite></a> trait.</p>
<p>If you only want to start <strong>one instance</strong> of your server per test file, make sure to override this
<cite>def</cite> with a <cite>val</cite>. See: <a class="reference external" href="#sharing-a-server-fixture-between-many-feature-tests">Sharing a Server Fixture Between Many Feature Tests</a>
for information on how to properly share a server test fixture.</p>
</div>
<p>We highly recommend writing <cite>FeatureTests</cite> for your services as they provide a very good signal of
whether you have correctly implemented the features of your service. As always, it is important to
always ask yourself, “<em>what are we trying to test?</em>” and to do what makes sense for your team but
we recommend including <cite>FeatureTests</cite> in your test suite.</p>
<div class="admonition-tl-dr admonition">
<p class="admonition-title">TL;DR</p>
<p>A test which implements the <cite>FeatureTest</cite> trait is for a <em>single configured instance of a server under test</em>.
Servers are not cheap to create and start, thus the typical pattern is to create (and usually start)
the server once <em>before</em> any test case runs. The <cite>FeatureTest</cite> trait will ensure that the instance
set to the <cite>server</cite> member is properly closed after all tests have been run.</p>
<p>In short, the workflow of a <cite>FeatureTest</cite> looks like this:</p>
<p><cite>instantiate test class –&gt; create/start server –&gt; run tests –&gt; close/stop server</cite></p>
</div>
<p>With the above in mind, it is possible to multiple servers in a test or test different configurations
of a server.</p>
<section id="testing-multiple-applications-or-servers">
<h2>Testing Multiple Applications or Servers<a class="headerlink" href="#testing-multiple-applications-or-servers" title="Permalink to this headline">¶</a></h2>
<p>For multiple servers, don’t use the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> trait since it is for testing a
single server. Just extend the <cite>c.t.inject.Test</cite> trait to implement your test using the <a class="reference external" href="embedded.html">embedded utilities</a>
to create and start your application. Note you will need to manually ensure to close any
created servers.</p>
<p>Many of the basics of feature testing mentioned here will still apply so it is still useful to read
through this documentation, just note again that you will need to ensure you manually close any created
servers to prevent any resource leaking in your tests.</p>
<p>Please take a look at these tests for examples of testing multiple embedded servers in a single test
file:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/test/scala/com/twitter/finatra/http/tests/integration/multiserver/test/MultiServerFeatureTest.scala">Http to Http example</a></p></li>
<li><p><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject-thrift-client-http-mapper/src/test/scala/com/twitter/finatra/multiserver/test/MultiServerFeatureTest.scala">Http to Http to Thrift example</a></p></li>
<li><p><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-thrift-client/src/test/scala/com/twitter/inject/thrift/MultiServerDarkTrafficFeatureTest.scala">Thrift to Thrift (via the DarkTrafficFilter) example</a></p></li>
<li><p><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-thrift-client/src/test/java/com/twitter/inject/thrift/integration/MultiJavaServerDarkTrafficFeatureTest.java">Thrift to Thrift (via the DarkTrafficFilter) Java example</a></p></li>
</ul>
</section>
<section id="testing-multiple-configurations-of-a-server">
<h2>Testing Multiple Configurations of a Server<a class="headerlink" href="#testing-multiple-configurations-of-a-server" title="Permalink to this headline">¶</a></h2>
<p>To test different configurations of a server, create different test files. That is, a test file should
map to a specific server configuration under test and test all the features of the configuration set.</p>
<p>For example if you had a server parameter that could either be ‘yellow’ or ‘green’ and wanted to
execute a suite of test cases against both of those configurations, the recommendation would be to
create two test files: <cite>YellowServerFeatureTest</cite> and <cite>GreenServerFeatureTest</cite>. Each test would have
the server configured accordingly.</p>
<p>See below for guidelines on how to <a class="reference external" href="#sharing-a-server-fixture-between-many-feature-tests">share a server fixture between feature tests</a>,
specifically the <a class="reference external" href="#id2">Sharing Test Cases</a> section.</p>
</section>
<section id="c-t-server-twitterserver">
<h2><a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a><a class="headerlink" href="#c-t-server-twitterserver" title="Permalink to this headline">¶</a></h2>
<p>Finatra’s <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> utility can be used for testing any extension of <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a>.
That is, you can start a locally running server and write tests that issue requests to it as long as the
server extends from <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> – the server under test does not specifically have to
be a server written using the Finatra framework.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some advanced features (like the automatic injection of an <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-stats/src/main/scala/com/twitter/finagle/stats/InMemoryStatsReceiver.scala">InMemoryStatsReceiver</a> for performing metrics assertions)
that require use of injection will not be available if you only extend <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> but you will be able
to start the server and test it in a controlled environment.</p>
<p>For more information on creating an “injectable” TwitterServer, <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala"><cite>c.t.inject.server.TwitterServer</cite></a> see the documentation
<a class="reference external" href="../twitter-server/index.html">here</a>.</p>
</div>
<p>Here’s an example of writing a test that starts a <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> and asserts that it reports itself “healthy”.</p>
<p>Given a simple <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.{</span><span class="nc">Http</span><span class="p">,</span> <span class="nc">ListeningServer</span><span class="p">,</span> <span class="nc">Service</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nn">http</span><span class="p">.{</span><span class="nc">Status</span><span class="p">,</span> <span class="nc">Response</span><span class="p">,</span> <span class="nc">Request</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">TwitterServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.{</span><span class="nc">Await</span><span class="p">,</span> <span class="nc">Future</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">MyTwitterServer</span> <span class="k">extends</span> <span class="nc">TwitterServer</span> <span class="p">{</span>
  <span class="k">private</span><span class="p">[</span><span class="bp">this</span><span class="p">]</span> <span class="kd">val</span> <span class="n">httpPortFlag</span> <span class="o">=</span>
    <span class="n">flag</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;http.port&quot;</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s">&quot;:8888&quot;</span><span class="p">,</span> <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;External HTTP server port&quot;</span><span class="p">)</span>

  <span class="k">private</span><span class="p">[</span><span class="bp">this</span><span class="p">]</span> <span class="k">def</span> <span class="nf">responseString</span><span class="p">:</span> <span class="nc">String</span> <span class="o">=</span> <span class="s">&quot;Hello, world!&quot;</span>
  <span class="k">private</span><span class="p">[</span><span class="bp">this</span><span class="p">]</span> <span class="kd">val</span> <span class="n">service</span> <span class="o">=</span> <span class="nc">Service</span><span class="p">.</span><span class="n">mk</span><span class="p">[</span><span class="nc">Request</span><span class="p">,</span> <span class="nc">Response</span><span class="p">]</span> <span class="p">{</span> <span class="n">request</span> <span class="o">=&gt;</span>
    <span class="kd">val</span> <span class="n">response</span> <span class="o">=</span>
      <span class="nc">Response</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="n">contentString</span> <span class="o">=</span> <span class="n">responseString</span>
    <span class="nc">Future</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="cm">/** Simple way to expose the bound port once the external listening server is started */</span>
  <span class="nd">@volatile</span> <span class="k">private</span><span class="p">[</span><span class="bp">this</span><span class="p">]</span> <span class="kd">var</span> <span class="n">_httpExternalPort</span><span class="p">:</span> <span class="nc">Option</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">def</span> <span class="nf">httpExternalPort</span><span class="p">:</span> <span class="nc">Option</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">this</span><span class="p">.</span><span class="n">_httpExternalPort</span>

  <span class="k">def</span> <span class="nf">main</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">server</span><span class="p">:</span> <span class="nc">ListeningServer</span> <span class="o">=</span> <span class="nc">Http</span><span class="p">.</span><span class="n">server</span>
      <span class="p">.</span><span class="n">withLabel</span><span class="p">(</span><span class="s">&quot;http&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="n">serve</span><span class="p">(</span><span class="n">httpPortFlag</span><span class="p">(),</span> <span class="n">service</span><span class="p">)</span>
    <span class="n">info</span><span class="p">(</span><span class="s">s&quot;Serving on port </span><span class="si">${</span><span class="n">httpPortFlag</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">info</span><span class="p">(</span><span class="s">s&quot;Serving admin interface on port </span><span class="si">${</span><span class="n">adminPort</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">onExit</span> <span class="p">{</span>
      <span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="bp">this</span><span class="p">.</span><span class="n">_httpExternalPort</span> <span class="o">=</span> <span class="nc">Some</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">boundAddress</span><span class="p">.</span><span class="k">asInstanceOf</span><span class="p">[</span><span class="nc">InetSocketAddress</span><span class="p">].</span><span class="n">getPort</span><span class="p">)</span>
    <span class="nc">Await</span><span class="p">.</span><span class="n">ready</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="writing-the-featuretest">
<h3>Writing the FeatureTest<a class="headerlink" href="#writing-the-featuretest" title="Permalink to this headline">¶</a></h3>
<p>First, extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> trait. Then override the <cite>server</cite> definition
with an instance of your <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala"><cite>EmbeddedTwitterServer</cite></a> which wraps your <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a>
under test.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.{</span><span class="nc">EmbeddedTwitterServer</span><span class="p">,</span> <span class="nc">FeatureTest</span><span class="p">,</span> <span class="nc">PortUtils</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">MyTwitterServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedTwitterServer</span><span class="p">(</span>
      <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyTwitterServer</span><span class="p">,</span>
      <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
      <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
        <span class="s">&quot;http.port&quot;</span> <span class="o">-&gt;</span> <span class="nc">PortUtils</span><span class="p">.</span><span class="n">ephemeralLoopback</span><span class="p">,</span>
        <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span>
      <span class="p">)</span>
    <span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;MyTwitterServer#starts&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">isHealthy</span> <span class="n">should</span> <span class="n">be</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="c-t-inject-server-twitterserver">
<h2><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala"><cite>c.t.inject.server.TwitterServer</cite></a><a class="headerlink" href="#c-t-inject-server-twitterserver" title="Permalink to this headline">¶</a></h2>
<p>For an “injectable” TwitterServer, <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/main/scala/com/twitter/inject/server/TwitterServer.scala"><cite>c.t.inject.server.TwitterServer</cite></a> the test would look exactly the same as above
for <a class="reference external" href="#c-t-server-twitterserver">c.t.server.TwitterServer</a> but you’ll be able to take advantage of the <a class="reference external" href="../getting-started/dependency_injection.html">Injector</a>
for overriding bound implementations to help create powerful tests.</p>
<p>See the next sections on <a class="reference internal" href="mocks.html#mocks"><span class="std std-ref">Working with Mocks</span></a>, <a class="reference internal" href="override_modules.html#override-modules"><span class="std std-ref">Override Modules</span></a>, and <a class="reference internal" href="bind_dsl.html#bind-dsl"><span class="std std-ref">Explicit Binding with #bind[T]</span></a> for details.</p>
<section id="testing-with-global-flags">
<h3>Testing With <cite>Global Flags</cite><a class="headerlink" href="#testing-with-global-flags" title="Permalink to this headline">¶</a></h3>
<p>See the section covering this topic in the <a class="reference external" href="embedded.html#testing-with-global-flags">Embedded Servers and Apps</a>
documentation.</p>
</section>
<section id="disabling-clients-using-dtabs">
<h3>Disabling Clients using <cite>Dtabs</cite><a class="headerlink" href="#disabling-clients-using-dtabs" title="Permalink to this headline">¶</a></h3>
<p>If you have Finagle clients defined in your server which are using <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/Dtab.scala">Dtab</a> delegation tables for client resolution and want to
keep them from making remote connections when your server starts, you can override the <cite>Dtab</cite> of the clients by
passing the <cite>-dtab.add</cite> flag (defined by the <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/DtabFlags.scala">c.t.finagle.DtabFlags</a> trait mixed into <a class="reference external" href="https://github.com/twitter/twitter-server/blob/55d6d28862f7f260f3171342ad8ca363553bac40/server/src/main/scala/com/twitter/server/TwitterServer.scala#L40">c.t.server.TwitterServer</a>)
to your server under test.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.{</span><span class="nc">EmbeddedTwitterServer</span><span class="p">,</span> <span class="nc">FeatureTest</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">MyTwitterServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedTwitterServer</span><span class="p">(</span>
      <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyTwitterServer</span><span class="p">,</span>
      <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
      <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
        <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;MyTwitterServer#starts&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">isHealthy</span> <span class="n">should</span> <span class="n">be</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="creating-a-client-to-the-server-under-test">
<h3>Creating a Client to the Server Under Test<a class="headerlink" href="#creating-a-client-to-the-server-under-test" title="Permalink to this headline">¶</a></h3>
<p>By default the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/EmbeddedTwitterServer.scala"><cite>EmbeddedTwitterServer</cite></a> will create a Finagle HTTP client to the
<a class="reference external" href="https://twitter.github.io/twitter-server/Admin.html">TwitterServer HTTP Admin interface</a>
accessible via <cite>EmbeddedTwitterServer#httpAdminClient</cite>.</p>
<p>To get any bound <em>external</em> port of the server under test, you’ll need to structure your code to expose
it for your test to be able to read once the server has been started. That is, the <a class="reference external" href="https://github.com/twitter/finagle/blob/cda049e7db679f62588eda1a18eadc846acb0b30/finagle-core/src/main/scala/com/twitter/finagle/Server.scala#L13">c.t.finagle.ListeningServer</a>
started in your <a class="reference external" href="https://github.com/twitter/twitter-server/blob/develop/server/src/main/scala/com/twitter/server/TwitterServer.scala"><cite>c.t.server.TwitterServer</cite></a> <cite>main()</cite> needs to be exposed such that you can call <cite>server.boundAddress</cite>
after the server has been started.</p>
<p>Assuming we have exposed this bound port as written above with <cite>MyTwitterServer#httpExternalPort</cite> we could create
a client:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nc">Http</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nn">http</span><span class="p">.{</span><span class="nc">Request</span><span class="p">,</span> <span class="nc">Status</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nn">request</span><span class="p">.</span><span class="nc">RequestBuilder</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.{</span><span class="nc">EmbeddedTwitterServer</span><span class="p">,</span> <span class="nc">FeatureTest</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">java</span><span class="p">.</span><span class="nn">net</span><span class="p">.</span><span class="nc">InetAddress</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">MyTwitterServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>

  <span class="k">private</span> <span class="kd">val</span> <span class="n">testServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyTwitterServer</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedTwitterServer</span><span class="p">(</span>
      <span class="n">twitterServer</span> <span class="o">=</span> <span class="n">testServer</span><span class="p">,</span>
      <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
      <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
        <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="k">private</span> <span class="k">lazy</span> <span class="kd">val</span> <span class="n">httpClient</span> <span class="o">=</span>
    <span class="nc">Http</span><span class="p">.</span><span class="n">client</span>
      <span class="p">.</span><span class="n">withSessionQualifier</span><span class="p">.</span><span class="n">noFailFast</span>
      <span class="p">.</span><span class="n">withSessionQualifier</span><span class="p">.</span><span class="n">noFailureAccrual</span>
      <span class="p">.</span><span class="n">newService</span><span class="p">(</span>
        <span class="s">s&quot;</span><span class="si">${</span><span class="nc">InetAddress</span>
              <span class="p">.</span><span class="n">getLoopbackAddress</span>
              <span class="p">.</span><span class="n">getHostAddress</span>
          <span class="si">}</span><span class="s">:</span><span class="si">${</span><span class="n">testServer</span><span class="p">.</span><span class="n">httpExternalPort</span><span class="p">.</span><span class="n">get</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">beforeAll</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;MyTwitterServer#starts&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">isHealthy</span> <span class="n">should</span> <span class="n">be</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;MyTwitterServer#feature&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">RequestBuilder</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;/foo&quot;</span><span class="p">)</span>

    <span class="kd">val</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span><span class="p">(</span><span class="n">httpClient</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="n">should</span> <span class="n">equal</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is where using the Finatra <cite>c.t.finatra.http.HttpServer</cite> or <cite>c.t.finatra.thrift.ThriftServer</cite> can help since much of the
client creation work can then be done for you by the framework’s testing tools, e.g., the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/test/scala/com/twitter/finatra/http/EmbeddedHttpServer.scala"><cite>EmbeddedHttpServer</cite></a> or
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/EmbeddedThriftServer.scala"><cite>EmbeddedThriftServer</cite></a> without the need to add code to expose anything your external <cite>ListeningServer</cite>.</p>
</section>
</section>
<section id="c-t-finatra-http-httpserver">
<h2><cite>c.t.finatra.http.HttpServer</cite><a class="headerlink" href="#c-t-finatra-http-httpserver" title="Permalink to this headline">¶</a></h2>
<p>To write a <cite>FeatureTest</cite> for an <cite>c.t.finatra.http.HttpServer</cite>, extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a>
trait. Then override the <cite>server</cite> definition with an instance of your <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/test/scala/com/twitter/finatra/http/EmbeddedHttpServer.scala"><cite>EmbeddedHttpServer</cite></a>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">Status</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">EmbeddedHttpServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">ExampleServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmbeddedHttpServer</span><span class="p">(</span>
    <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExampleServer</span><span class="p">,</span>
    <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
      <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;ExampleServer#perform feature&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span>
      <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">,</span>
      <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;ExampleServer#perform another feature with a response&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">response</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span>
      <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/foo&quot;</span><span class="p">,</span>
      <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>

    <span class="n">response</span><span class="p">.</span><span class="n">contentString</span> <span class="n">should</span> <span class="n">equal</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note: The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/test/scala/com/twitter/finatra/http/EmbeddedHttpServer.scala"><cite>EmbeddedHttpServer</cite></a> creates a client to the external HTTP interface defined by the server and exposes
methods which use the client for issuing HTTP requests to the server under test.</p>
<p>You can also create a <cite>c.t.finagle.http.Request</cite> and execute it with the test HTTP client. Finatra has a simple <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/httpclient/src/main/scala/com/twitter/finatra/httpclient/RequestBuilder.scala">RequestBuilder</a>
to help easily construct a <cite>c.t.finagle.http.Request</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">Status</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">EmbeddedHttpServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nn">request</span><span class="p">.</span><span class="nc">RequestBuilder</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">ExampleServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmbeddedHttpServer</span><span class="p">(</span>
    <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExampleServer</span><span class="p">,</span>
    <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
      <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;ExampleServer#perform feature&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span>
      <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">,</span>
      <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;ExampleServer#perform feature with built request&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">RequestBuilder</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>

    <span class="kd">val</span> <span class="n">response</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">httpClient</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="n">should</span> <span class="n">equal</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="c-t-finatra-thrift-thriftserver">
<h2><cite>c.t.finatra.thrift.ThriftServer</cite><a class="headerlink" href="#c-t-finatra-thrift-thriftserver" title="Permalink to this headline">¶</a></h2>
<p>Similarly, to write a <cite>FeatureTest</cite> for a <cite>c.t.finatra.thrift.ThriftServer</cite> and create a <a class="reference external" href="https://twitter.github.io/finagle/">Finagle</a>
<a class="reference external" href="#thrift-tests">client</a> to it, extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> trait, override the
<cite>server</cite> definition with an instance of your <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/EmbeddedThriftServer.scala"><cite>EmbeddedThriftServer</cite></a>, and then create a Thrift client
from the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/EmbeddedThriftServer.scala"><cite>EmbeddedThriftServer</cite></a>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="nn">thriftscala</span><span class="p">.</span><span class="nc">ExampleThrift</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">conversions</span><span class="p">.</span><span class="nc">DurationOps</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nc">EmbeddedThriftServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nc">Await</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">ExampleThriftServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmbeddedThriftServer</span><span class="p">(</span>
    <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExampleThriftServer</span><span class="p">,</span>
    <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
      <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="o">=</span>
    <span class="n">server</span><span class="p">.</span><span class="n">thriftClient</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;ExampleThriftServer#return data accordingly&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">await</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">doExample</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">))</span> <span class="n">should</span> <span class="n">equal</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Again, note that tests should <strong>always</strong> define a timeout for any <a class="reference external" href="https://github.com/twitter/util/blob/54f314d1f4b37d302f685e99b1ac416e48532a04/util-core/src/main/scala/com/twitter/util/Awaitable.scala#L77"><cite>c.t.util.Await</cite></a> call. We use the <a class="reference external" href="https://github.com/twitter/finatra/blob/ea0b7a6655f4a8df84b5933c0ade19cae311c098/inject/inject-core/src/test/scala/com/twitter/inject/TestMixin.scala#L103">#await</a>
function in the above example.</p>
</div>
<section id="thrift-client-interface-types">
<h3>Thrift Client Interface Types<a class="headerlink" href="#thrift-client-interface-types" title="Permalink to this headline">¶</a></h3>
<p>As mentioned in the Scrooge <a class="reference external" href="https://twitter.github.io/scrooge/Finagle.html">Finagle Integration</a>
documentation, users have three API choices for building an interface to a Finagle Thrift client —
<code class="docutils literal notranslate"><span class="pre">ServicePerEndpoint</span></code>, <code class="docutils literal notranslate"><span class="pre">ReqRepServicePerEndpoint</span></code>, and <code class="docutils literal notranslate"><span class="pre">MethodPerEndpoint</span></code>. This is true even
when creating a test Thrift client to a Thrift server.</p>
<p>In the example above, we create a Thrift client in the form of the higher-kinded type interface,
e.g., <cite>MyService[+MM[_]]</cite>. We could choose to create a <cite>ExampleThrift.MethodPerEndpoint</cite>
interface instead by changing the type parameter given to the <a class="reference external" href="https://github.com/twitter/finatra/blob/72664be4439da4425dfe63fa325f4c1ebbc5bf4b/thrift/src/test/scala/com/twitter/finatra/thrift/ThriftClient.scala#L77"><cite>c.t.finatra.thrift.ThriftClient#thriftClient[T]</cite></a>
method:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="o">=</span>
  <span class="n">server</span><span class="p">.</span><span class="n">thriftClient</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Users can also choose to create a <cite>service-per-endpoint</cite> Thrift client interface by calling the
<a class="reference external" href="https://github.com/twitter/finatra/blob/72664be4439da4425dfe63fa325f4c1ebbc5bf4b/thrift/src/test/scala/com/twitter/finatra/thrift/ThriftClient.scala#L103"><cite>c.t.finatra.thrift.ThriftClient#servicePerEndpoint[T]</cite></a> with either the <code class="docutils literal notranslate"><span class="pre">ServicePerEndpoint</span></code> or
<code class="docutils literal notranslate"><span class="pre">ReqRepServicePerEndpoint</span></code> type. E.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span> <span class="o">=</span>
  <span class="n">server</span><span class="p">.</span><span class="n">servicePerEndpoint</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ReqRepServicePerEndpoint</span> <span class="o">=</span>
  <span class="n">server</span><span class="p">.</span><span class="n">servicePerEndpoint</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ReqRepServicePerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Lastly, the Thrift client can also be expressed as a <code class="docutils literal notranslate"><span class="pre">MethodPerEndpoint</span></code> wrapping a
<cite>service-per-endpoint</cite> type by using <a class="reference external" href="https://github.com/twitter/finatra/blob/72664be4439da4425dfe63fa325f4c1ebbc5bf4b/thrift/src/test/scala/com/twitter/finatra/thrift/ThriftClient.scala#L134"><cite>c.t.finatra.thrift.ThriftClient#methodPerEndpoint[T, U]</cite></a>.
This would allow for applying a set of filters on the Thrift client interface before interacting
with the Thrift client as a <code class="docutils literal notranslate"><span class="pre">MethodPerEndpoint</span></code> interface.</p>
<p>For example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">lazy</span> <span class="kd">val</span> <span class="n">servicePerEndpoint</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span> <span class="o">=</span>
  <span class="n">server</span>
    <span class="p">.</span><span class="n">servicePerEndpoint</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">filtered</span><span class="p">(</span><span class="o">???</span><span class="p">)</span>

<span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="o">=</span>
  <span class="n">server</span><span class="p">.</span><span class="n">methodPerEndpoint</span><span class="p">[</span>
    <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span><span class="p">,</span>
    <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span><span class="p">](</span><span class="n">servicePerEndpoint</span><span class="p">)</span>
</pre></div>
</div>
<p>See the <a class="reference external" href="../thrift/clients.html">Communicate with a Thrift Service</a> section for more information
on Thrift clients.</p>
</section>
<section id="closing-the-test-client-interface">
<h3>Closing the Test Client Interface<a class="headerlink" href="#closing-the-test-client-interface" title="Permalink to this headline">¶</a></h3>
<p>It is considered a best practice to close any created test Thrift client interface to ensure that any
opened resources are closed.</p>
<p>For instance, if you are instantiating a single Thrift client interface for all of your tests, you
could close the client in the ScalaTest <cite>afterAll</cite> lifecycle block. E.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="nn">thriftscala</span><span class="p">.</span><span class="nc">ExampleThrift</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">conversions</span><span class="p">.</span><span class="nc">DurationOps</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nc">EmbeddedThriftServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.{</span><span class="nc">Await</span><span class="p">,</span> <span class="nc">Duration</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">ExampleThriftServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">defaultAwaitTimeout</span><span class="p">:</span> <span class="nc">Duration</span> <span class="o">=</span> <span class="mi">2</span><span class="p">.</span><span class="n">seconds</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmbeddedThriftServer</span><span class="p">(</span>
    <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExampleThriftServer</span><span class="p">,</span>
    <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
      <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span> <span class="o">=</span>
    <span class="n">server</span><span class="p">.</span><span class="n">servicePerEndpoint</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>

  <span class="p">...</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">afterAll</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">await</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">asClosable</span><span class="p">.</span><span class="n">close</span><span class="p">())</span>
    <span class="bp">super</span><span class="p">.</span><span class="n">afterAll</span><span class="p">()</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Note that the above example use a default <cite>timeout</cite> of <cite>2.seconds</cite> on awaiting the close of the test Thrift
client interface. You can and should adjust this value – either up or down – as appropriate for
your testing.</p>
</section>
</section>
<section id="combined-c-t-finatra-http-httpserver-c-t-finatra-thrift-thriftserver">
<h2>Combined <cite>c.t.finatra.http.HttpServer</cite> &amp; <cite>c.t.finatra.thrift.ThriftServer</cite><a class="headerlink" href="#combined-c-t-finatra-http-httpserver-c-t-finatra-thrift-thriftserver" title="Permalink to this headline">¶</a></h2>
<p>If you are extending both <cite>c.t.finatra.http.HttpServer</cite> <strong>and</strong> <cite>c.t.finatra.thrift.ThriftServer</cite>
then you can <cite>FeatureTest</cite> by constructing an <cite>EmbeddedHttpServer with ThriftClient</cite>, e.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="nn">thriftscala</span><span class="p">.</span><span class="nc">ExampleThrift</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">conversions</span><span class="p">.</span><span class="nc">DurationOps</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">EmbeddedHttpServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nc">ThriftClient</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">class</span> <span class="nc">ExampleCombinedServerFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedHttpServer</span><span class="p">(</span>
      <span class="n">twitterServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExampleCombinedServer</span><span class="p">,</span>
      <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
      <span class="n">flags</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">(</span>
        <span class="s">&quot;dtab.add&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;/$/inet=&gt;/$/nil;/zk=&gt;/$/nil&quot;</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">with</span> <span class="nc">ThriftClient</span>

  <span class="k">lazy</span> <span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="o">=</span>
    <span class="n">server</span><span class="p">.</span><span class="n">thriftClient</span><span class="p">[</span><span class="nc">ExampleThrift</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span><span class="p">](</span><span class="n">clientId</span> <span class="o">=</span> <span class="s">&quot;client123&quot;</span><span class="p">)</span>

  <span class="s">&quot;ExampleCombinedServer#perform feature&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">,</span>
        <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
        <span class="p">...</span>
    <span class="p">}</span>

   <span class="s">&quot;ExampleCombinedServer#return data accordingly&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">await</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">doExample</span><span class="p">(</span><span class="s">&quot;input&quot;</span><span class="p">))</span> <span class="n">should</span> <span class="n">equal</span><span class="p">(</span><span class="s">&quot;output&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="sharing-a-server-fixture-between-many-feature-tests">
<h2>Sharing a Server Fixture Between Many Feature Tests<a class="headerlink" href="#sharing-a-server-fixture-between-many-feature-tests" title="Permalink to this headline">¶</a></h2>
<p>There may be times in testing where you want to share an embedded server configuration among
different FeatureTests. That is, you want to be able to create and setup the embedded server in the
same way (perhaps with minor configuration changes) across many different test files.</p>
<p>One idea might be to define a “base” test trait which extends <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a> that
your tests can extend.</p>
<p>Creating a “base” trait that defines shared state is a fine strategy. However, when doing so it
is generally considered a best practice to <strong>not</strong> share an instance of an embedded server.
That is, issues can arise when this “base” trait overrides and implements the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-server/src/test/scala/com/twitter/inject/server/FeatureTest.scala"><cite>c.t.inject.server.FeatureTest</cite></a>
trait <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">server</span></code>.</p>
<p>Thus, we recommend to <em>always</em> implement the abstract <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">server</span></code> in each <em>actual</em> <cite>FeatureTest</cite>
implementation.</p>
<p>This does not mean that you cannot share a configured embedded server fixture. To do so effectively
and efficiently, have the “base” trait define a utility method which allows a <cite>FeatureTest</cite>
implementation to obtain an instance of an embedded server fixture which it can then set as <em>its</em>
embedded server for testing.</p>
<p>For example, we could define a “base” testing trait:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">EmbeddedHttpServer</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">trait</span> <span class="nc">BaseMyServiceFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="p">{</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">:</span> <span class="nc">Foo</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="nf">baz</span><span class="p">:</span> <span class="nc">Baz</span>

  <span class="c1">// Note, this merely provides a way for extensions of this trait to</span>
  <span class="c1">// get a commonly configurable EmbeddedHttpServer. Or it could define</span>
  <span class="c1">// an non-configurable version to ensure every test can use a similarly</span>
  <span class="c1">// configured server.</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="nf">buildExampleServiceTestServer</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="n">flags</span><span class="p">:</span> <span class="o">=&gt;</span> <span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">()</span>
  <span class="p">):</span> <span class="nc">EmbeddedHttpServer</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedHttpServer</span><span class="p">(</span><span class="k">new</span> <span class="nc">ExampleHttpServer</span> <span class="p">{</span>
      <span class="k">override</span> <span class="kd">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="k">override</span> <span class="kd">val</span> <span class="n">overrideModules</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span><span class="o">???</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
  <span class="p">).</span><span class="n">bind</span><span class="p">[</span><span class="nc">Foo</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
   <span class="p">.</span><span class="n">bind</span><span class="p">[</span><span class="nc">Baz</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="n">baz</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This “base” trait defines a method for obtaining a properly configured embedded server for test
implementations to use. Then in tests we could do:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nn">mock</span><span class="p">.</span><span class="nc">Mockito</span>

<span class="k">class</span> <span class="nc">MyServiceFirstFeatureTest</span> <span class="k">extends</span> <span class="nc">BaseMyServiceFeatureTest</span> <span class="k">with</span> <span class="nc">Mockito</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">foo</span><span class="p">:</span> <span class="nc">Foo</span> <span class="o">=</span> <span class="n">mock</span><span class="p">[</span><span class="nc">Foo</span><span class="p">]</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">baz</span><span class="p">:</span> <span class="nc">Baz</span> <span class="o">=</span> <span class="n">mock</span><span class="p">[</span><span class="nc">Baz</span><span class="p">]</span>

  <span class="c1">// We override and implement the c.t.inject.server.FeatureTest#server as a val in our actual test file</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="n">buildExampleServiceTestServer</span><span class="p">(</span>
    <span class="s">&quot;firstFeatureServer&quot;</span><span class="p">,</span>
    <span class="nc">Map</span><span class="p">(</span><span class="s">&quot;aaa.baz&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;forty-two&quot;</span><span class="p">))</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;Feature 1 should do X&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">???</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="k">class</span> <span class="nc">MyServiceOtherFeatureTest</span> <span class="k">extends</span> <span class="nc">BaseMyServiceFeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">foo</span><span class="p">:</span> <span class="nc">Foo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DummyFoo</span><span class="p">()</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">baz</span><span class="p">:</span> <span class="nc">Baz</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BazStub</span><span class="p">()</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="n">buildExampleServiceTestServer</span><span class="p">(</span>
    <span class="s">&quot;secondFeatureServer&quot;</span>
    <span class="nc">Map</span><span class="p">(</span><span class="s">&quot;aaa.baz&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;thirty-five&quot;</span><span class="p">))</span>
  <span class="p">)</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;Feature 2 should do Y&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">???</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="reasons">
<h3>Reasons<a class="headerlink" href="#reasons" title="Permalink to this headline">¶</a></h3>
<p>Firstly, embedded servers close over specific configuration state (flags and other args) of the server
under test. Additionally, many servers are composed of JVM singletons (framework and potentially
user-defined) which expect to be the only instance present or running at any given time. That is,
there are no guarantees of thread-safety by default.</p>
<p>Thus, you can run into issues with inconsistent state of a shared embedded server fixture due to multiple
tests accessing it potentially in parallel. Semantics change depending on your build system and testing
framework, but it is generally a good practice to <em>not</em> share a single instance of an embedded server.</p>
<p>Secondly, when the server is defined as a <cite>val</cite> in a “base” trait from which many tests inherit,
<strong>the same server can end up being started multiple times</strong> – even when you are attempting to run a
single test. Why? Some build systems optimize their test runs by first loading all test classes before
running a single test file or test case. When this occurs, all test classes will be instantiated and
thus any constructor <cite>val</cite> eagerly loaded. This could therefore start the embedded server <cite>val</cite>
in <em>each test</em> inheriting from the “base” trait and can generally lead to undesirable performance
when testing, thus the recommendation to always override the server member of <cite>FeatureTest</cite>
<strong>in the actual test file</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Finatra’s testing utilities attempt to start servers lazily but any eager reference to the
server’s Injector would trigger the server to start in order to create and return the Injector.</p>
</div>
</section>
<section id="id2">
<h3>Sharing Test Cases<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Note that you could also extend this in the situation where you want to run the same test cases over
<strong>differently configured</strong> instances of the same server. Your “base” trait would similarly provide
a method for obtaining a properly configured embedded server for test instances to use <em>as well as implement test cases</em>.</p>
<p>Each subclass implementation would then just cycle through different server configurations, setting
that configuration as it’s own <cite>server</cite> under test.</p>
<p>For example, we could extend our defined “base” testing trait to include test cases:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">EmbeddedHttpServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">server</span><span class="p">.</span><span class="nc">FeatureTest</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nn">mock</span><span class="p">.</span><span class="nc">Mockito</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">collection</span><span class="p">.</span><span class="nn">immutable</span><span class="p">.</span><span class="nc">ListMap</span>

<span class="k">trait</span> <span class="nc">BaseMyServiceFeatureTest</span> <span class="k">extends</span> <span class="nc">FeatureTest</span> <span class="k">with</span> <span class="nc">Mockito</span> <span class="p">{</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">:</span> <span class="nc">Foo</span> <span class="o">=</span> <span class="n">mock</span><span class="p">[</span><span class="nc">Foo</span><span class="p">]</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="nf">baz</span><span class="p">:</span> <span class="nc">Baz</span> <span class="o">=</span> <span class="n">mock</span><span class="p">[</span><span class="nc">Baz</span><span class="p">]</span>

  <span class="c1">// provide a way to create a configured server under test</span>
  <span class="k">protected</span> <span class="k">def</span> <span class="nf">buildExampleServiceTestServer</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
    <span class="n">flags</span><span class="p">:</span> <span class="o">=&gt;</span> <span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">]</span> <span class="o">=</span> <span class="nc">Map</span><span class="p">()</span>
  <span class="p">):</span> <span class="nc">EmbeddedHttpServer</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">EmbeddedHttpServer</span><span class="p">(</span><span class="k">new</span> <span class="nc">ExampleHttpServer</span> <span class="p">{</span>
      <span class="k">override</span> <span class="kd">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="k">override</span> <span class="kd">val</span> <span class="n">overrideModules</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span><span class="o">???</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">globalFlags</span> <span class="o">=</span> <span class="nc">ListMap</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">some</span><span class="p">.</span><span class="n">globalFlag</span><span class="p">.</span><span class="n">disable</span> <span class="o">-&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">),</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
  <span class="p">).</span><span class="n">bind</span><span class="p">[</span><span class="nc">Foo</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
   <span class="p">.</span><span class="n">bind</span><span class="p">[</span><span class="nc">Baz</span><span class="p">].</span><span class="n">toInstance</span><span class="p">(</span><span class="n">baz</span><span class="p">)</span>

  <span class="c1">// we want all subclasses to run these same tests</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;Feature 1 should do it&#39;s thing&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// &#39;server&#39; is defined as an abstract member in `FeatureTest` thus we can reference it here</span>
    <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span><span class="s">&quot;/feature1&quot;</span><span class="p">,</span> <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;Feature 2 should do it&#39;s thing&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span><span class="s">&quot;/feature2&quot;</span><span class="p">,</span> <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s">&quot;Feature 3 should do it&#39;s thing&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">httpGet</span><span class="p">(</span><span class="s">&quot;/feature3&quot;</span><span class="p">,</span> <span class="n">andExpect</span> <span class="o">=</span> <span class="nc">Status</span><span class="p">.</span><span class="nc">Ok</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then in tests we would do:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyServiceFirstFeatureTest</span> <span class="k">extends</span> <span class="nc">BaseMyServiceFeatureTest</span> <span class="p">{</span>
  <span class="c1">// We override and implement the c.t.inject.server.FeatureTest#server as a val in our actual test file</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="n">buildExampleServiceTestServer</span><span class="p">(</span>
    <span class="s">&quot;firstFeatureServer&quot;</span><span class="p">,</span>
    <span class="nc">Map</span><span class="p">(</span><span class="s">&quot;aaa.baz&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;forty-two&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="k">class</span> <span class="nc">MyServiceOtherFeatureTest</span> <span class="k">extends</span> <span class="nc">BaseMyServiceFeatureTest</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">val</span> <span class="n">server</span> <span class="o">=</span> <span class="n">buildExampleServiceTestServer</span><span class="p">(</span>
    <span class="s">&quot;secondFeatureServer&quot;</span>
    <span class="nc">Map</span><span class="p">(</span><span class="s">&quot;aaa.baz&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;thirty-five&quot;</span><span class="p">))</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These subclasses would run the test cases from the superclass but each using their own server
configuration.</p>
<p>For more information on mocking, see the <a class="reference external" href="./mocks.html">Working with Mocks</a> documentation.</p>
</section>
</section>
<section id="injecting-members-of-a-test">
<h2>Injecting Members of a Test<a class="headerlink" href="#injecting-members-of-a-test" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not inject members of a test class into the server, application or TestInjector object graph under test.</p>
</div>
<p>For an explanation of why, see the documentation <a class="reference external" href="./bind_dsl.html#injecting-members-of-a-test">here</a>.</p>
</section>
<section id="examples">
<h2>Examples:<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>the
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/test/scala/com/twitter/finatra/http/tests/integration/doeverything/test/DoEverythingServerFeatureTest.scala">DoEverythingServerFeatureTest</a>
for an HTTP server.</p></li>
<li><p>the
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/test/scala/com/twitter/finatra/thrift/tests/DoEverythingThriftServerFeatureTest.scala">DoEverythingThriftServerFeatureTest</a>
for a Thrift server.</p></li>
<li><p>the
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject-thrift-client-http-mapper/src/test/scala/com/twitter/finatra/multiserver/test/DoEverythingCombinedServerFeatureTest.scala">DoEverythingCombinedServerFeatureTest</a>
for “combined” HTTP and Thrift server.</p></li>
</ul>
</section>
<section id="more-information">
<h2>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="index.html"><span class="doc">Testing Features</span></a></p></li>
<li><p><a class="reference internal" href="embedded.html"><span class="doc">Embedded Servers and Apps</span></a></p></li>
<li><p><a class="reference internal" href="integration_tests.html"><span class="doc">Integration Tests</span></a></p></li>
<li><p><a class="reference internal" href="startup_tests.html"><span class="doc">Startup Tests</span></a></p></li>
<li><p><a class="reference internal" href="mixins.html"><span class="doc">Test Mixins</span></a></p></li>
<li><p><a class="reference internal" href="mocks.html"><span class="doc">Working with Mocks</span></a></p></li>
<li><p><a class="reference internal" href="override_modules.html"><span class="doc">Override Modules</span></a></p></li>
<li><p><a class="reference internal" href="bind_dsl.html"><span class="doc">Explicit Binding with #bind[T]</span></a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Feature Tests</a><ul>
<li><a class="reference internal" href="#testing-multiple-applications-or-servers">Testing Multiple Applications or Servers</a></li>
<li><a class="reference internal" href="#testing-multiple-configurations-of-a-server">Testing Multiple Configurations of a Server</a></li>
<li><a class="reference internal" href="#c-t-server-twitterserver"><cite>c.t.server.TwitterServer</cite></a><ul>
<li><a class="reference internal" href="#writing-the-featuretest">Writing the FeatureTest</a></li>
</ul>
</li>
<li><a class="reference internal" href="#c-t-inject-server-twitterserver"><cite>c.t.inject.server.TwitterServer</cite></a><ul>
<li><a class="reference internal" href="#testing-with-global-flags">Testing With <cite>Global Flags</cite></a></li>
<li><a class="reference internal" href="#disabling-clients-using-dtabs">Disabling Clients using <cite>Dtabs</cite></a></li>
<li><a class="reference internal" href="#creating-a-client-to-the-server-under-test">Creating a Client to the Server Under Test</a></li>
</ul>
</li>
<li><a class="reference internal" href="#c-t-finatra-http-httpserver"><cite>c.t.finatra.http.HttpServer</cite></a></li>
<li><a class="reference internal" href="#c-t-finatra-thrift-thriftserver"><cite>c.t.finatra.thrift.ThriftServer</cite></a><ul>
<li><a class="reference internal" href="#thrift-client-interface-types">Thrift Client Interface Types</a></li>
<li><a class="reference internal" href="#closing-the-test-client-interface">Closing the Test Client Interface</a></li>
</ul>
</li>
<li><a class="reference internal" href="#combined-c-t-finatra-http-httpserver-c-t-finatra-thrift-thriftserver">Combined <cite>c.t.finatra.http.HttpServer</cite> &amp; <cite>c.t.finatra.thrift.ThriftServer</cite></a></li>
<li><a class="reference internal" href="#sharing-a-server-fixture-between-many-feature-tests">Sharing a Server Fixture Between Many Feature Tests</a><ul>
<li><a class="reference internal" href="#reasons">Reasons</a></li>
<li><a class="reference internal" href="#id2">Sharing Test Cases</a></li>
</ul>
</li>
<li><a class="reference internal" href="#injecting-members-of-a-test">Injecting Members of a Test</a></li>
<li><a class="reference internal" href="#examples">Examples:</a></li>
<li><a class="reference internal" href="#more-information">More Information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="embedded.html" title="previous chapter">Embedded Servers and Apps</a></li>
      <li>Next: <a href="integration_tests.html" title="next chapter">Integration Tests</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2024 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>