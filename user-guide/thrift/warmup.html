
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Thrift Server Warmup &#8212; Finatra 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/flasky.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Communicate with a Thrift Service" href="clients.html" />
    <link rel="prev" title="Thrift Exception Mapping" href="exceptions.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="clients.html" title="Communicate with a Thrift Service"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="exceptions.html" title="Thrift Exception Mapping"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Thrift Server Warmup</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="thrift-server-warmup">
<span id="thrift-warmup"></span><h1>Thrift Server Warmup<a class="headerlink" href="#thrift-server-warmup" title="Permalink to this headline">¶</a></h1>
<p>There may be occasions where we want to exercise specific code paths before accepting traffic to the
server (e.g., for triggering JIT in the JVM). We can do this via server warmup.</p>
<section id="warmup">
<h2>Warmup<a class="headerlink" href="#warmup" title="Permalink to this headline">¶</a></h2>
<p>Finatra provides a <cite>warmup</cite> lifecycle callback function which will be executed in the correct phase
of server startup, i.e, before the server’s external Thrift port is bound and thus before the
TwitterServer <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#lifecycle-management">Lifecycle Management</a>
<cite>/health</cite> endpoint responds with <cite>OK</cite>.</p>
<p>See <a class="reference external" href="../getting-started/lifecycle.html">here</a> for more information on the lifecycle of a Finatra
server.</p>
<p>To perform warmup, simply override this callback method and implement your logic. E.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nc">DoEverythingModule</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nc">ThriftServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nn">routing</span><span class="p">.</span><span class="nc">ThriftRouter</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nn">filters</span><span class="p">.</span><span class="n">_</span>

<span class="k">object</span> <span class="nc">ExampleServerMain</span> <span class="k">extends</span> <span class="nc">ExampleServer</span>

<span class="k">class</span> <span class="nc">ExampleServer</span> <span class="k">extends</span> <span class="nc">ThriftServer</span> <span class="p">{</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">modules</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span>
    <span class="nc">DoEverythingModule</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">configureThrift</span><span class="p">(</span><span class="n">router</span><span class="p">:</span> <span class="nc">ThriftRouter</span><span class="p">):</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">router</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">LoggingMDCFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">TraceIdMDCFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">ThriftMDCFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">AccessLoggingFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">StatsFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">add</span><span class="p">[</span><span class="nc">ExampleThriftController</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">warmup</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// YOUR WARMUP LOGIC HERE &lt;----------------------------------------------</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="c-t-finatra-thrift-routing-thriftwarmup">
<h2><cite>c.t.finatra.thrift.routing.ThriftWarmup</cite><a class="headerlink" href="#c-t-finatra-thrift-routing-thriftwarmup" title="Permalink to this headline">¶</a></h2>
<p>Finatra provides a utility, <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/routing/ThriftWarmup.scala">c.t.finatra.thrift.routing.ThriftWarmup</a>
which will route requests to underlying service implementation configured by the
<a class="reference external" href="https://github.com/twitter/finatra/blob/ad4b1fb37d13ae7b27aae50b885fa4ecfd0ed105/thrift/src/main/scala/com/twitter/finatra/thrift/routing/ThriftRouter.scala#L35">ThriftRouter</a>.</p>
<p>The most common way to use the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/routing/ThriftWarmup.scala">c.t.finatra.thrift.routing.ThriftWarmup</a>
is via a constructor-arg to an implementation of a
<a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-utils/src/main/scala/com/twitter/inject/utils/Handler.scala">c.t.inject.utils.Handler</a>.</p>
<p>The Finatra <cite>c.t.inject.serverTwitterServer</cite> provides a <cite>#handle[T &lt;: Handler: Manifest]</cite> utility
which simply instantiates a given <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-utils/src/main/scala/com/twitter/inject/utils/Handler.scala">c.t.inject.utils.Handler</a>
via the injector and invokes its <cite>#handle()</cite> function.</p>
<p>Combining the above, if we wanted to run an initial call through our Thrift service we could create
the following handler:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nc">ExampleThriftController</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="nn">thriftscala</span><span class="p">.</span><span class="nc">ExampleService</span><span class="p">.</span><span class="nc">Add1</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nn">routing</span><span class="p">.</span><span class="nc">ThriftWarmup</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Logging</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nn">utils</span><span class="p">.</span><span class="nc">Handler</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.{</span><span class="nc">Await</span><span class="p">,</span> <span class="nc">Return</span><span class="p">,</span> <span class="nc">Throw</span><span class="p">,</span> <span class="nc">Try</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">scala</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nn">control</span><span class="p">.</span><span class="nc">NonFatal</span>
<span class="k">import</span> <span class="nn">javax</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Inject</span>

<span class="k">class</span> <span class="nc">ExampleThriftWarmupHandler</span> <span class="nd">@Inject</span><span class="p">()(</span>
 <span class="n">warmup</span><span class="p">:</span> <span class="nc">ThriftWarmup</span><span class="p">)</span>
 <span class="k">extends</span> <span class="nc">Handler</span>
 <span class="k">with</span> <span class="nc">Logging</span> <span class="p">{</span>

  <span class="cm">/* Should be a ClientId that is white-listed to your service. */</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="n">clientId</span> <span class="o">=</span> <span class="nc">ClientId</span><span class="p">(</span><span class="s">&quot;client123&quot;</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">clientId</span><span class="p">.</span><span class="n">asCurrent</span> <span class="p">{</span>
          <span class="n">warmup</span><span class="p">.</span><span class="n">send</span><span class="p">(</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nc">Add1</span><span class="p">,</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nc">Add1</span><span class="p">.</span><span class="nc">Args</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="p">{</span> <span class="n">result</span><span class="p">:</span> <span class="nc">Try</span><span class="p">[</span><span class="nc">Add1</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span> <span class="o">=&gt;</span>
              <span class="n">result</span> <span class="k">match</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nc">Return</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">assert</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&quot;Warmup request failed.&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="nc">Throw</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s">&quot;Warmup request failed.&quot;</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nc">NonFatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="c1">// Here we don&#39;t want a warmup failure to prevent server start-up --</span>
        <span class="c1">// this is important if your service will call downstream services</span>
        <span class="c1">// during warmup that could be temporarily down or unavailable.</span>
        <span class="c1">// We don&#39;t want that unavailability to cause our server to fail</span>
        <span class="c1">// warm-up and thus prevent the server from starting. So we simply</span>
        <span class="c1">// log the error message here.</span>
        <span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">getMessage</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">info</span><span class="p">(</span><span class="s">&quot;Warm-up done.&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The handler above simply tries to call the <cite>Add1</cite> endpoint of the server.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>As noted above, be careful about exceptions which occur from calling endpoints on your service
during warmup. Exceptions which escape the handler will potentially stop your server from
starting and thus, you most likely <strong>do not</strong> want an exception from a warmup call to propagate out
of the handler.</p>
</div>
<p>You would then run this handler in <cite>warmup()</cite> lifecycle callback E.g.,</p>
<p>E.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nc">DoEverythingModule</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nc">ThriftServer</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nn">routing</span><span class="p">.</span><span class="nc">ThriftRouter</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">thrift</span><span class="p">.</span><span class="nn">filters</span><span class="p">.</span><span class="n">_</span>

<span class="k">object</span> <span class="nc">ExampleServerMain</span> <span class="k">extends</span> <span class="nc">ExampleServer</span>

<span class="k">class</span> <span class="nc">ExampleServer</span> <span class="k">extends</span> <span class="nc">ThriftServer</span> <span class="p">{</span>

  <span class="k">override</span> <span class="kd">val</span> <span class="n">modules</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">(</span>
    <span class="nc">DoEverythingModule</span><span class="p">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">configureThrift</span><span class="p">(</span><span class="n">router</span><span class="p">:</span> <span class="nc">ThriftRouter</span><span class="p">):</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">router</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">LoggingMDCFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">TraceIdMDCFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">ThriftMDCFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">AccessLoggingFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">StatsFilter</span><span class="p">]</span>
      <span class="p">.</span><span class="n">add</span><span class="p">[</span><span class="nc">ExampleThriftController</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">warmup</span><span class="p">():</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">handle</span><span class="p">[</span><span class="nc">ExampleThriftWarmupHandler</span><span class="p">]()</span> <span class="o">&lt;----------------------------------------------</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="more-information">
<h2>More information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<p>For more information, we encourage you to take a look at the full
<a class="reference external" href="https://github.com/twitter/finatra/tree/master/examples">finatra/examples</a> in the
<a class="reference external" href="https://github.com/twitter/finatra">github</a> source.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Thrift Server Warmup</a><ul>
<li><a class="reference internal" href="#warmup">Warmup</a></li>
<li><a class="reference internal" href="#c-t-finatra-thrift-routing-thriftwarmup"><cite>c.t.finatra.thrift.routing.ThriftWarmup</cite></a></li>
<li><a class="reference internal" href="#more-information">More information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="exceptions.html" title="previous chapter">Thrift Exception Mapping</a></li>
      <li>Next: <a href="clients.html" title="next chapter">Communicate with a Thrift Service</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2024 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>