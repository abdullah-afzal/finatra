
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Validation Framework Integration &#8212; Finatra 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/flasky.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Jackson Integration" href="../json/index.html" />
    <link rel="prev" title="HTTP Server Warmup" href="../http/warmup.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../json/index.html" title="Jackson Integration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../http/warmup.html" title="HTTP Server Warmup"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Finatra</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">User’s Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Validation Framework Integration</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="validation-framework-integration">
<span id="validation"></span><h1>Validation Framework Integration<a class="headerlink" href="#validation-framework-integration" title="Permalink to this headline">¶</a></h1>
<p>Finatra provides an integration with the <a class="reference external" href="https://github.com/twitter/util/tree/develop/util-validator">util-validator</a>
<a class="reference external" href="https://github.com/twitter/util/blob/develop/util-validator/src/main/scala/com/twitter/util/validation/ScalaValidator.scala"><cite>c.t.util.validation.ScalaValidator</cite></a> for use in validating the fields of a Scala
<a class="reference external" href="https://docs.scala-lang.org/tour/case-classes.html">case class</a>.</p>
<p>For more information on the <a class="reference external" href="https://github.com/twitter/util/tree/develop/util-validator">util-validator</a>  library,
please see the <a class="reference external" href="http://twitter.github.io/util/guide/util-validator/index.html">documentation</a>.</p>
<section id="using-a-customized-scalavalidator">
<h2>Using a customized <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-validator/src/main/scala/com/twitter/util/validation/ScalaValidator.scala"><cite>ScalaValidator</cite></a><a class="headerlink" href="#using-a-customized-scalavalidator" title="Permalink to this headline">¶</a></h2>
<p>You can customize and provide a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-validator/src/main/scala/com/twitter/util/validation/ScalaValidator.scala"><cite>ScalaValidator</cite></a> via a <cite>TwitterModule</cite>. The easiest way to do so is
to extend the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/validation/src/main/scala/com/twitter/finatra/validation/ValidatorModule.scala">c.t.finatra.validation.ValidatorModule</a>
and implement the <cite>ValidatorModule#configureValidator</cite> method:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span> <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">validation</span><span class="p">.</span><span class="nc">ValidatorModule</span>
 <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">Injector</span>
 <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nn">validation</span><span class="p">.</span><span class="nc">ScalaValidator</span>
 <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nn">validation</span><span class="p">.</span><span class="nn">cfg</span><span class="p">.</span><span class="nc">ConstraintMapping</span>

 <span class="k">object</span> <span class="nc">CustomizedValidatorModule</span> <span class="k">extends</span> <span class="nc">ValidatorModule</span> <span class="p">{</span>
<span class="hll">   <span class="k">override</span> <span class="k">def</span> <span class="nf">configureValidator</span><span class="p">(</span><span class="n">injector</span><span class="p">:</span> <span class="nc">Injector</span><span class="p">,</span> <span class="n">builder</span><span class="p">:</span> <span class="nc">ScalaValidator</span><span class="p">.</span><span class="nc">Builder</span><span class="p">):</span> <span class="nc">ScalaValidator</span><span class="p">.</span><span class="nc">Builder</span> <span class="o">=</span> <span class="p">{</span>
</span>     <span class="kd">val</span> <span class="n">newConstraintMapping</span> <span class="o">=</span> <span class="nc">ConstraintMapping</span><span class="p">(</span>
        <span class="n">annotationType</span> <span class="o">=</span> <span class="k">classOf</span><span class="p">[</span><span class="nc">FooConstraintAnnotation</span><span class="p">],</span>
        <span class="n">constraintValidator</span> <span class="o">=</span> <span class="k">classOf</span><span class="p">[</span><span class="nc">FooConstraintValidator</span><span class="p">]</span>
      <span class="p">)</span>

     <span class="n">builder</span>
       <span class="p">.</span><span class="n">withDescriptorCacheSize</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
       <span class="p">.</span><span class="n">withConstraintMapping</span><span class="p">(</span><span class="n">newConstraintMapping</span><span class="p">)</span>
   <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>Then include this module in your server’s list of modules. In a Finatra HTTP server, a <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-validator/src/main/scala/com/twitter/util/validation/ScalaValidator.scala"><cite>ScalaValidator</cite></a>
is provided as a <a class="reference external" href="../http/server.html#framework-modules">framework module</a>, thus you can use your new module as the implementation of
the <cite>validatorModule</cite> function in your <a class="reference external" href="../http/server.html#framework-modules">HttpServer definition</a>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span> <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nc">HttpServer</span>
 <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finatra</span><span class="p">.</span><span class="nn">http</span><span class="p">.</span><span class="nn">routing</span><span class="p">.</span><span class="nc">HttpRouter</span>
 <span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">inject</span><span class="p">.</span><span class="nc">TwitterModule</span>

 <span class="nc">ServerWithCustomizedValidator</span> <span class="k">extends</span> <span class="nc">HttpServer</span> <span class="p">{</span>
   <span class="k">override</span> <span class="kd">val</span> <span class="n">name</span><span class="p">:</span> <span class="nc">String</span> <span class="o">=</span> <span class="s">&quot;validation-server&quot;</span>
<span class="hll">   <span class="k">override</span> <span class="k">def</span> <span class="nf">validatorModule</span><span class="p">:</span> <span class="nc">TwitterModule</span> <span class="o">=</span> <span class="nc">CustomizedValidatorModule</span>
</span>
   <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">configureHttp</span><span class="p">(</span><span class="n">router</span><span class="p">:</span> <span class="nc">HttpRouter</span><span class="p">):</span> <span class="nc">Unit</span> <span class="o">=</span> <span class="p">{</span>
     <span class="n">router</span>
       <span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="nc">MyFilter</span><span class="p">]</span>
       <span class="p">.</span><span class="n">add</span><span class="p">[</span><span class="nc">MyController</span><span class="p">]</span>
       <span class="p">...</span>
   <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>By overriding the default <cite>validatorModule</cite> in an <a class="reference external" href="../http/server.html#framework-modules">HttpServer</a>,
you are also replacing the default <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-validator/src/main/scala/com/twitter/util/validation/ScalaValidator.scala"><cite>ScalaValidator</cite></a> used by the framework <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/jackson/ScalaObjectMapper.scala"><cite>ScalaObjectMapper</cite></a>
provided by the default framework <a class="reference external" href="https://github.com/twitter/finatra/blob/ef7197324cba8dfe6274ffb4570dea6c34b9fc33/http/src/main/scala/com/twitter/finatra/http/servers.scala#L526">jacksonModule</a>.</p>
<p>The newly defined <a class="reference external" href="https://github.com/twitter/util/blob/develop/util-validator/src/main/scala/com/twitter/util/validation/ScalaValidator.scala"><cite>ScalaValidator</cite></a> will be used to apply the validation logic in the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/jackson/ScalaObjectMapper.scala"><cite>ScalaObjectMapper</cite></a>.</p>
<p>See <a class="reference external" href="#integration-with-finatra-jackson-support">Integration with Finatra Jackson Support</a>
for more information about how case class validations work in the Finatra Jackson Framework.</p>
</div>
</section>
<section id="integration-with-finatra-jackson-support">
<h2>Integration with Finatra Jackson Support<a class="headerlink" href="#integration-with-finatra-jackson-support" title="Permalink to this headline">¶</a></h2>
<p>The Finatra framework integrates with Jackson in a couple of ways.</p>
<section id="scalaobjectmapper">
<h3><a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/jackson/ScalaObjectMapper.scala"><cite>ScalaObjectMapper</cite></a><a class="headerlink" href="#scalaobjectmapper" title="Permalink to this headline">¶</a></h3>
<p>The first and most straight-forward is through the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/jackson/ScalaObjectMapper.scala"><cite>ScalaObjectMapper</cite></a>. The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/jackson/ScalaObjectMapper.scala"><cite>ScalaObjectMapper</cite></a>
directly integrates with the <a class="reference external" href="http://twitter.github.io/util/guide/util-validator/index.html">util-validator</a>
library via the <cite>case class</cite> <a class="reference external" href="../json/index.html#improved-case-class-deserializer">deserializer</a>
to efficiently execute field and method validations as a part of JSON deserialization. For details
on case class validation during JSON deserialization, please refer to <a class="reference external" href="../json/validations.html">JSON Validation Framework</a>.</p>
</section>
<section id="http-routing">
<h3>HTTP Routing<a class="headerlink" href="#http-routing" title="Permalink to this headline">¶</a></h3>
<p>Secondly, Jackson support is also integrated with Finatra’s <a class="reference external" href="../json/routing.html">HTTP Routing</a> to
allow for validation of JSON request bodies when modeled as a <a class="reference external" href="../http/requests.html#custom-case-class-request-object">custom request case class</a>.</p>
<p>For example, if you have the following HTTP <a class="reference external" href="../http/requests.html#custom-case-class-request-object">custom request case class</a>
defined:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">jakarta</span><span class="p">.</span><span class="nn">validation</span><span class="p">.</span><span class="nn">constraints</span><span class="p">.{</span><span class="nc">Max</span><span class="p">,</span> <span class="nc">NotEmpty</span><span class="p">}</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nn">validation</span><span class="p">.</span><span class="nn">constraints</span><span class="p">.</span><span class="nc">Pattern</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ValidateUserRequest</span><span class="p">(</span>
  <span class="nd">@NotEmpty</span> <span class="nd">@Pattern</span><span class="p">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">&quot;[a-z]+&quot;</span><span class="p">)</span> <span class="n">userName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
  <span class="nd">@Max</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">)</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
  <span class="n">title</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And in your HTTP controller, you define a <cite>POST</cite> endpoint:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">post</span><span class="p">(</span><span class="s">&quot;/validate_user&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">_:</span> <span class="nc">ValidateUserRequest</span> <span class="o">=&gt;</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When a <cite>POST</cite> request with a content-type of <cite>application/json</cite> is sent to the <cite>/validate_user/</cite>
endpoint of the server, Finatra will <a class="reference external" href="../http/requests.html#custom-case-class-request-object">automatically deserialize</a>
the incoming request body into a <cite>ValidationUserRequest</cite> case class. During deserialization the annotated
constraints will be applied to the fields as part of instance construction.</p>
<p>If any validation constraint fails during JSON deserialization, a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/jackson/src/main/scala/com/twitter/finatra/json/internal/caseclass/exceptions/CaseClassMappingException.scala">CaseClassMappingException</a>
will be thrown which is handled by the <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/http-server/src/main/scala/com/twitter/finatra/http/internal/exceptions/json/CaseClassExceptionMapper.scala">CaseClassExceptionMapper</a>
in a Finatra <a class="reference external" href="../http/exceptions.html#default-exception-mappers">HttpServer by default</a> to translate
the exception into a suitable HTTP response.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Non-recoverable validation errors are generally thrown as <cite>jakarta.validation.ValidationException</cite> which are
handled by the <cite>ThrowableExceptionMapper &lt;https://github.com/twitter/finatra/blob/develop/http-server/src/main/scala/com/twitter/finatra/http/internal/exceptions/ThrowableExceptionMapper.scala&gt;</cite>
in a Finatra <a class="reference external" href="../http/exceptions.html#default-exception-mappers">HttpServer by default</a> to translate
the exception into a suitable HTTP response.</p>
</div>
</section>
</section>
<section id="best-practices-guidance-limitations">
<h2>Best Practices, Guidance &amp; Limitations<a class="headerlink" href="#best-practices-guidance-limitations" title="Permalink to this headline">¶</a></h2>
<p>Please refer to the <a class="reference external" href="http://twitter.github.io/util/guide/util-validator/index.html">util-validator</a>
documentation <a class="reference external" href="http://twitter.github.io/util/guide/util-validator/index.html">for details</a>.</p>
<ul>
<li><p>Case classes used for validation should be side-effect free under property access. That is, accessing a
case class field should be able to be done eagerly and without side-effects.</p></li>
<li><p>Case classes with generic type params should be considered <strong>not supported</strong> for validation. E.g.,</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">GenericCaseClass</span><span class="p">[</span><span class="nc">T</span><span class="p">](</span><span class="nd">@NotEmpty</span> <span class="nd">@Valid</span> <span class="n">data</span><span class="p">:</span> <span class="nc">T</span><span class="p">)</span>
</pre></div>
</div>
<p>This may appear to work for some category of data but in practice the way the <a class="reference external" href="http://twitter.github.io/util/guide/util-validator/index.html">util-validator</a>
caches reflection data does not discriminate on the type binding and thus validation of genericized
case classes is not guaranteed to be successful for differing type bindings of a given genericized class.
Note that this case works in the Jackson <a class="reference external" href="../json/index.html#improved-case-class-deserializer">integration</a>
due to different caching semantics and how Jackson deserialization works where the binding type
information is known.</p>
</li>
<li><p>While <cite>Iterable</cite> collections are supported for validation when annotated with <cite>&#64;Valid</cite>, this does
not include <cite>Map</cite> types. Annotated <cite>Map</cite> types will be ignored during validation.</p></li>
<li><p>More generally, types with multiple type params, e.g. <cite>Either[T, U]</cite>, are not supported for validation
of contents when annotated with <cite>&#64;Valid</cite>. Annotated unsupported types will be <strong>ignored</strong> during validation.</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  <a href="https://github.com/twitter/finatra">Finatra</a> is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/user-guide">User's&nbsp;Guide</a></li>
  <li><a href="https://finagle.github.io/blog/">Finagle&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Finatra&nbsp;on&nbsp;Github</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Github&nbsp;Issues</a></li>
</ul>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Validation Framework Integration</a><ul>
<li><a class="reference internal" href="#using-a-customized-scalavalidator">Using a customized <cite>ScalaValidator</cite></a></li>
<li><a class="reference internal" href="#integration-with-finatra-jackson-support">Integration with Finatra Jackson Support</a><ul>
<li><a class="reference internal" href="#scalaobjectmapper"><cite>ScalaObjectMapper</cite></a></li>
<li><a class="reference internal" href="#http-routing">HTTP Routing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#best-practices-guidance-limitations">Best Practices, Guidance &amp; Limitations</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">User’s Guide</a><ul>
      <li>Previous: <a href="../http/warmup.html" title="previous chapter">HTTP Server Warmup</a></li>
      <li>Next: <a href="../json/index.html" title="next chapter">Jackson Integration</a></li>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2024 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>